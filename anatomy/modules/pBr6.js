/**
 * id: pBr6
 * path: ./live-player/live-player
 */

(function(require,module,exports) {
"use strict";var e,t,r,i,n,o,l,a,s,u,c,d,p,h,y,f,v,g,m,E,P,S,w,T,C,I,_,b,L,V=this&&this.__assign||function(){return(V=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},k=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function l(e){try{s(i.next(e))}catch(t){o(t)}}function a(e){try{s(i.throw(e))}catch(t){o(t)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(l,a)}s((i=i.apply(e,t||[])).next())})},M=this&&this.__generator||function(e,t){var r,i,n,o,l={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;l;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return l.label++,{value:o[1],done:!1};case 5:l.label++,i=o[1],o=[0];continue;case 7:o=l.ops.pop(),l.trys.pop();continue;default:if(!(n=(n=l.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){l=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){l.label=o[1];break}if(6===o[0]&&l.label<n[1]){l.label=n[1],n=o;break}if(n&&l.label<n[2]){l.label=n[2],l.ops.push(o);break}n[2]&&l.ops.pop(),l.trys.pop();continue}o=t.call(e,l)}catch(a){o=[6,a],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},U=this&&this.__classPrivateFieldSet||function(e,t,r){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,r),r},N=this&&this.__classPrivateFieldGet||function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},H=this&&this.__spreadArray||function(e,t){for(var r=0,i=t.length,n=e.length;r<i;r++,n++)e[n]=t[r];return e},D=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LivePlayer=exports.LivePlayerEvent=exports.isBwpSupported=void 0;var F=require("@bilibili-live/web-player-common"),Q=require("@bilibili-live/web-player-video"),x=D(require("@bilibili-live/web-player-playurl-parser")),A=D(require("../common/controller")),W=D(require("./p2p-adapter")),q=require("../common/utils"),O=require("../common/track-video"),B=D(require("@bilibili-live/web-player-track")),R=D(require("./replay")),K=require("../common/connects"),j=D(require("./sticker")),J=require("./hevc-adapter"),G=require("./live-player-tool"),z=require("./switch-better-line"),X=require("./retry-strategy"),Y=require("./panorama"),Z=require("./hevc-adapter");Object.defineProperty(exports,"isBwpSupported",{enumerable:!0,get:function(){return Z.isBwpSupported}});var $,ee=((e={})[F.P2PType.HLS_BILI]=F.P2PType.HLS_NOT_P2P,e[F.P2PType.FLV_QVB]=F.P2PType.NONE,e[F.P2PType.HLS_NOT_P2P]=F.P2PType.HLS_NOT_P2P,e[F.P2PType.NONE]=F.P2PType.NONE,e);!function(e){e.Failed="liveplayer-failed",e.LiveStatusChange="liveplayer-status-change",e.Destroyed="liveplayer-destroyed",e.VideoError="VideoError"}($=exports.LivePlayerEvent||(exports.LivePlayerEvent={}));var te=function(){function e(e,H,D){var W,K=this;this.container=e,this.opts=H,this.socket=D,t.set(this,""),r.set(this,""),i.set(this,null),n.set(this,null),this.playUrlParser=null,o.set(this,0),this.replay=null,l.set(this,[]),a.set(this,[]),s.set(this,null),u.set(this,!1),c.set(this,null),d.set(this,null),p.set(this,"Fetch"),h.set(this,void 0),y.set(this,null),f.set(this,function(){}),v.set(this,!1),g.set(this,new F.EventBus),this.on=N(this,g).on,this.once=N(this,g).once,this.emit=N(this,g).emit,m.set(this,new Set),E.set(this,null),P.set(this,null),S.set(this,function(e){return k(K,void 0,Promise,function(){var t,r,i,l,s=this;return M(this,function(u){switch(u.label){case 0:return U(this,o,e),this.opts.roomId=e,F.logger.info("live player init roomId: "+e),null!=this.opts.roomInfo?[3,2]:[4,N(this,C).call(this)];case 1:return u.sent(),[3,3];case 2:if(U(this,n,this.opts.roomInfo),null==N(this,n).playurl_info.playurl)return this.emit($.Failed,B.default.ErrorCode.PlayUrlNull),F.logger.error("playUrlInfo.playurl is null"),[2];this.playUrlParser=ue(N(this,n).playurl_info,{userId:this.opts.userId,ownerId:N(this,n).uid,isMobile:null!==(t=this.opts.isMobile)&&void 0!==t&&t}),u.label=3;case 3:return this.reload(),null!=(null===(r=N(this,n))||void 0===r?void 0:r.live_time)&&N(this,a).push(ie(N(this,n).live_time,this.ctrl.getCtrlUI())),null!=N(this,n)&&!0!==this.opts.isMobile&&this.opts.enableCtrlUI&&(this.replay=new R.default(this.container,{live_time:null===(i=N(this,n))||void 0===i?void 0:i.live_time,rid:null===(l=N(this,n))||void 0===l?void 0:l.room_id},this.socket,this.ctrl),this.replay.on("timeShiftChange",function(e){s.tmShiftHandler(e),s.reload(),e>0&&U(s,P,null)}),this.enableReplay()&&this.replay.init()),[2]}})})}),this.tmShiftHandler=function(e){var t,r,i,n=K.playUrlParser;if(null!=K.replay&&null!=n){var o=n.getCurP2PType(),l=n.getCurStreamInfo().protocol,a=F.ProtocolType.HTTP_HLS,s=F.P2PType.HLS_NOT_P2P,u=n.getCurStreamInfo().timeshift;0!==e?(0===u&&(K.replay.bakState={p2pType:o,protocol:l}),(null!==(t=K.replay.bakState.p2pType)&&void 0!==t?t:o)>0&&(n.setCurP2PType(F.P2PType.HLS_BILI),s=F.P2PType.HLS_BILI)):(s=null!==(r=K.replay.bakState.p2pType)&&void 0!==r?r:o,n.setCurP2PType(s),a=null!==(i=K.replay.bakState.protocol)&&void 0!==i?i:l,K.replay.bakState={}),n.setTimeShift(e),n.useStream({protocol:a,expectP2PType:s})}},w.set(this,function(e){var t,r,i=null!==(r=null===(t=K.playUrlParser)||void 0===t?void 0:t.getLineCandidates().length)&&void 0!==r?r:0,n=new z.SwitchBetterLine(e.getVideoEl(),{lineNum:i}),o=e.on(Q.EventType.WaitStart,function(){var t,r,i;if(!0!==(null===(t=K.replay)||void 0===t?void 0:t.isReplay)&&n.getNeedSwitchLine()){var o=performance.now(),l=navigator.connection;K.switchLine(z.SwitchBetterLine.switchNum,!1),B.default.custom(B.default.CustomCode.SwitchLine,{switchNum:z.SwitchBetterLine.switchNum,videoCurrentTime:e.getVideoEl().currentTime,interval:Math.floor((o-z.SwitchBetterLine.lastSwitchTime)/1e3),downlink:null!==(r=null==l?void 0:l.downlink)&&void 0!==r?r:-1,rtt:null!==(i=null==l?void 0:l.rtt)&&void 0!==i?i:-1}),F.logger.warn("waiting auto switch line to "+z.SwitchBetterLine.switchNum)}});N(K,l).push(n.destroy),N(K,l).push(o)}),T.set(this,function(){N(K,l).forEach(function(e){return e()}),U(K,l,[])}),C.set(this,q.retry(function(e){return k(K,void 0,Promise,function(){var t,r,i,l,a,s,u,d,p,h,y,f,v,g,m,E,P;return M(this,function(S){switch(S.label){case 0:return t=this.playUrlParser,r=null!==(h=null===(p=null==t?void 0:t.getQualityDesc(t.getCurQuality()))||void 0===p?void 0:p.code)&&void 0!==h?h:0,null!=e&&(r=e),q.loadingOrCoverImg(this.container,N(this,c)),i=null!==(f=null===(y=this.playUrlParser)||void 0===y?void 0:y.getCurLine())&&void 0!==f?f:0,l=(null!==(g=null===(v=this.playUrlParser)||void 0===v?void 0:v.getCurStreamInfo())&&void 0!==g?g:{}).timeshift,F.logger.info("updateRoomInfo quality: "+r+", line: "+i),[4,this.opts.roomInfoProvider({roomId:N(this,o),qn:r,isMobile:null!==(m=this.opts.isMobile)&&void 0!==m&&m})];case 1:return a=S.sent(),s=a.code,u=a.data,d=a.message,s===F.ApiErrorCode.AreaBlock?(this.emit($.Failed,F.ApiErrorCode.AreaBlock,d),[2]):1!==u.live_status?(F.unloading(),this.emit($.LiveStatusChange,u.live_status),[2]):null==u.playurl_info?(F.unloading(),this.playUrlParser=null,F.logger.info("playUrlInfo is null"),[2]):(U(this,n,u),F.logger.debug("room info: "+JSON.stringify(u)),null==u.playurl_info.playurl?(this.emit($.Failed,B.default.ErrorCode.PlayUrlNull),F.logger.error("playUrlInfo.playurl is null"),[2]):(this.playUrlParser=ue(N(this,n).playurl_info,{userId:this.opts.userId,ownerId:u.uid,isMobile:null!==(E=this.opts.isMobile)&&void 0!==E&&E}),null===(P=this.playUrlParser)||void 0===P||P.setCurLine(i),this.tmShiftHandler(null!=l?l:0),[2]))}})})},[0,1,3,5,10,20,30,60,90,120].map(function(e){return 1e3*e}))),I.set(this,function(e,n){e.once(Q.EventType.FirstFrame,function(){var o,a,c=null;if(N(K,l).push(function(){null==c||c.remove()}),N(K,m).forEach(function(t){t!==e&&(t.destroy(),N(K,m).delete(t))}),U(K,t,F.uuid()),U(K,r,n),N(K,u))e.destroy();else{null===(o=N(K,i))||void 0===o||o.removeVideoEl();var d=e.getVideoEl();K.container.appendChild(d),U(K,i,e),!0!==K.opts.isMobile&&(c=Q.checkVideoRate(e.getVideoEl())),null===(a=N(K,s))||void 0===a||a.success(),N(K,f).call(K),U(K,f,oe(e,N(K,y)))}})}),_.set(this,function(e){var t,r,i,n,o=q.maxRetryChecker(e);e.once(Q.EventType.Ended,function(){return k(K,void 0,void 0,function(){return M(this,function(t){return e.destroy(),o()?(a().catch(F.logger.error),[2]):(F.logger.error("retry over 1 min"),this.emit($.Failed,B.default.ErrorCode.RetryMaxTime),[2])})})}),e.once(Q.EventType.Error,function(t){return k(K,void 0,void 0,function(){var r,i,n;return M(this,function(l){return this.emit($.VideoError,t),e.destroy(),F.logger.error(t),o()?(r=q.loadingOrCoverImg(this.container,N(this,c)),!0===(null===(i=this.replay)||void 0===i?void 0:i.isReplay)?[2]:(x.default.Support_HEVC_No_Err&&t.code===B.default.ErrorCode.NativeVideoError?[3,4].includes(t.errInfo.code):t.code===B.default.ErrorCode.ErrorMseOpen&&/NotSupportedError.+hvc1/.test(t.errInfo.info))?(x.default.Support_HEVC_No_Err=!1,null===(n=this.playUrlParser)||void 0===n||n.useStream({codec:F.CodecType.AVC}),this.reload(),[2]):(a().then(r).catch(function(e){F.logger.error(e),r()}),[2])):(this.emit($.Failed,B.default.ErrorCode.RetryMaxTime),[2])})})}),F.logger.debug("max retry times："+(null!==(r=null===(t=K.playUrlParser)||void 0===t?void 0:t.getPlayUrlCandates().length)&&void 0!==r?r:0));var l=Math.min(null!==(n=null===(i=K.playUrlParser)||void 0===i?void 0:i.getPlayUrlCandates().length)&&void 0!==n?n:0,4),a=function(){return k(K,void 0,Promise,function(){var e,t,r,i;return M(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,7]),[4,q.backoffById(this.playUrlParser,l)];case 1:if(e=n.sent(),null!=this.playUrlParser)if((t=X.useRetryStrategy(this.playUrlParser,e,l))===X.RetryStrategies.SwitchLine)this.emit(F.ExternalEventType.SwitchLine,this.playUrlParser.getCurLine());else if(t===X.RetryStrategies.Failed)throw new Error("not supported hls protocol stream");return[3,7];case 2:r=n.sent(),F.logger.error(r),n.label=3;case 3:return n.trys.push([3,5,,6]),[4,N(this,C).call(this)];case 4:return n.sent(),[3,6];case 5:throw i=n.sent(),this.emit($.Failed,B.default.ErrorCode.RoomP0ApiFetchError),this.destroy(),i;case 6:return[3,7];case 7:return this.reload(),[2]}})})}}),b.set(this,function(e){var t=F.seiKeyComparator(F.SEIType.LIVE_SEI_CHANNEL),r=F.seiKeyComparator(F.SEIType.B_LIVE_VIBRATION),i=F.seiKeyComparator(F.SEIType.LIVE_SEI_PC_LINK),n=F.seiKeyComparator(F.SEIType.BVC_KUAWAN____TS),o=F.seiKeyComparator(F.SEIType.BVCLIVESTREAMHOP);return e.once(Q.EventType.Destroyed,function(){K.emit(Q.EventType.Destroyed)}),[F.EventBus.forwardEvent(e,N(K,g),[Q.EventType.Play,Q.EventType.Pause,Q.EventType.LoadStart,Q.EventType.MetaData,Q.EventType.FirstFrame,Q.EventType.WaitStart,Q.EventType.WaitEnd,Q.EventType.NotAutoPlay,Q.EventType.MutePlay,Q.EventType.CorePlayerCreated]),e.on(Q.EventType.VideoInfo,function(e){var t,r;K.emit(Q.EventType.VideoInfo,{mediaInfo:V(V({},e.mediaInfo),{corePlayerType:(null!==(r=null===(t=e.mediaInfo)||void 0===t?void 0:t.corePlayerType)&&void 0!==r?r:"")+" ("+N(K,p)+")"}),realtimeInfo:V(V({},e.realtimeInfo),{latency:N(K,P)})})}),e.on(Q.EventType.SEIData,function(){for(var e=[],l=0;l<arguments.length;l++)e[l]=arguments[l];if(t(e[2])){var a=F.uint8ArrayToString(e[3]);K.emit(F.ExternalEventType.SEIParseData,F.SEIType.LIVE_SEI_CHANNEL,a)}else if(r(e[2]))K.emit(F.ExternalEventType.SEIParseData,F.SEIType.B_LIVE_VIBRATION,e[1],e[3]);else if(i(e[2])){a=F.uint8ArrayToString(e[3]);K.emit(F.ExternalEventType.SEIParseData,F.SEIType.LIVE_SEI_PC_LINK,a)}else if(n(e[2])){a=F.uint8ArrayToString(e[3]);K.emit(F.ExternalEventType.SEIParseData,F.SEIType.BVC_KUAWAN____TS,a)}else o(e[2])?N(K,L).call(K,e):K.emit(Q.EventType.SEIData,e)}),e.once(Q.EventType.WASMDecoderDegrade,function(){var e=K.playUrlParser;if(null!=e){var t=e.getQualityDesc();if((null==t?void 0:t.codec)===F.CodecType.HEVC){var r=G.getHEVCDowngradeQn(t,e.getAVCQnCandidates());K.switchQuality(r,"CPU负载较高，")}}})]}),this.play=function(){var e;null===(e=N(K,i))||void 0===e||e.play().catch(function(){})},this.pause=function(){var e;null===(e=N(K,i))||void 0===e||e.pause()},this.volume=function(e){var t;null===(t=N(K,i))||void 0===t||t.volume(e)},this.switchAudioTrack=function(e){var t,r;return null!==(r=null===(t=N(K,i))||void 0===t?void 0:t.switchAudioTrack(e))&&void 0!==r?r:-1},this.getAudioTracks=function(){var e;return null===(e=N(K,i))||void 0===e?void 0:e.getAudioTracks()},this.mute=function(e){var t;null===(t=N(K,i))||void 0===t||t.mute(e)},this.enableReplay=function(){return null!=N(K,n)&&null!=K.playUrlParser&&!(!N(K,n).all_special_types.includes(19)||!K.playUrlParser.hasHLSPlayerSupportStream())},L.set(this,function(e){var t,r,n;if(!document.hidden&&!0!==(null===(t=K.replay)||void 0===t?void 0:t.isReplay)){var o=null===(r=N(K,i))||void 0===r?void 0:r.getVideoEl();if(null!=o&&!o.paused){var l=[];try{l=JSON.parse(F.uint8ArrayToString(e[3]))}catch(h){return void F.logger.error("bvc latency sei解析失败")}var a=K.playUrlParser,s=null!==(n=null==a?void 0:a.getCurStreamInfo())&&void 0!==n?n:{},u=s.format,c=s.p2pType,d=e[1],p=Math.round(1e3*(d-o.currentTime)+Date.now());l.length>0&&U(K,P,p-l[0].curr_ms),de(l.concat({curr_ms:p,author:"web_player",author_ver:"v3.6.134",buffer_ms:Math.round(1e3*F.remainBufferLength(o)),protocol:null!=c&&c===F.P2PType.HLS_BILI?"webrtc":"http",muxer:u})),pe(function(){U(K,P,null)})}}}),!0!==H.isMobile&&(e.style.overflow="hidden"),this.ctrl=new A.default(e,{userId:H.userId,isMobile:null!==(W=this.opts.isMobile)&&void 0!==W&&W,enableCtrlUI:H.enableCtrlUI}),re(this.ctrl,this,e),U(this,h,O.createVideoTracker()),N(this,S).call(this,this.opts.roomId).catch(function(e){F.logger.error(e),B.default.error(B.default.ErrorCode.RoomEnterLiveError,e)})}return e.prototype.reload=function(){var e,t,r,i=this;if(!N(this,u)){F.logger.info("live player load roomId: "+N(this,o));var a=N(this,o);if(null!=N(this,n)&&0!==a&&null!=this.playUrlParser){var s,y=this.playUrlParser;null==N(this,d)&&U(this,d,y.getCurQuality());try{s=y.getCurPlayUrl()}catch(L){return F.logger.error(L),void N(this,C).call(this).then(function(){i.reload()}).catch(function(e){F.logger.error(e)})}if(!N(this,u)){var f=y.getCurStreamInfo();B.default.updateDynamicInfo({p2pType:f.p2pType,sHost:f.host,sQuery:f.query,sProtocol:f.protocol,sCodec:f.codec,sName:f.name,quality:f.quality,sFormat:null!==(r=f.format)&&void 0!==r?r:"",line:this.playUrlParser.getCurLine()},!0);var g=B.default.fixedDynamicFieldsVerIns();F.logger.info("current stream info: "+JSON.stringify(f)),N(this,T).call(this);var P=new Q.Video(s,{wasmDecode:y.getCurCodecType()===F.CodecType.HEVC&&!F.isHardSupportHEVC()&&J.isWASMSupportHEVC(),forceNativePlayer:"panorama"===y.getCurStreamInfo().curAttrName||navigator.userAgent.includes("PlayStation")});f.codec===F.CodecType.HEVC&&g.updateDynamicInfo({videoTag:P.getVideoEl().tagName}),(e=N(this,l)).push.apply(e,ce(this.playUrlParser,this.container,a.toString(),P.getVideoEl(),this.ctrl)),N(this,m).add(P),ae(this.ctrl.getCtrlUI(),y,F.wpd.SupportHEVC||F.isHardSupportHEVC()||N(this,v)),N(this,w).call(this,P),se(P,this,this.container),N(this,I).call(this,P,s),N(this,_).call(this,P),N(this,h).call(this,P),(t=N(this,l)).push.apply(t,H([K.connectUIandVideo(this.ctrl,P),ne(P),K.connectVideoLoading(P,this.container,N(this,c)),K.connectVideoPip(P,this.ctrl),K.connectMirror(P,this.ctrl)],N(this,b).call(this,P)));var S=y.getCurP2PType();W.default({video:P,type:S,roomId:a,interval:y.getDynamicConfig().report_interval_sec}).then(function(e){var t;null!=e&&(U(i,E,e),N(i,h).setP2PInstance(P,e),N(i,l).push(function(){U(i,E,null)})),U(i,p,(t={},t[F.P2PType.HLS_BILI]="SistersFetcher",t[F.P2PType.FLV_QVB]="QVBFetcher",t[F.P2PType.HLS_NOT_P2P]="Fetch",t[F.P2PType.NONE]="Fetch",t)[S])}).catch(function(e){var t;U(i,p,"Fetch"),y.setCurP2PType(ee[S]),g.updateDynamicInfo({p2pType:ee[S]}),F.logger.error(e),null===(t=N(i,E))||void 0===t||t.destroy(),U(i,E,null)})}}}},e.prototype.setTitlePageImg=function(e){U(this,c,e)},e.prototype.setAutoSyncCfg=function(e){/chrome\/91/g.test(navigator.userAgent.toLowerCase())||(U(this,y,e),null!=N(this,i)&&(N(this,f).call(this),U(this,f,oe(N(this,i),e))))},e.prototype.getPlayerInfo=function(){var e,n,o,l,a,s;return{guid:N(this,t),playingStatus:!(null===(n=null===(e=N(this,i))||void 0===e?void 0:e.getVideoEl().paused)||void 0===n||n),playSrc:N(this,r),quality:null!==(l=null===(o=this.playUrlParser)||void 0===o?void 0:o.getCurQuality())&&void 0!==l?l:"",qualityCandidates:null!==(s=null===(a=this.playUrlParser)||void 0===a?void 0:a.getQnCandidates())&&void 0!==s?s:[]}},e.prototype.getVideoEl=function(){var e;return null===(e=N(this,i))||void 0===e?void 0:e.getVideoEl()},e.prototype.getP2PTransport=function(){var e,t;return{downloadExtraFile:null===(e=N(this,E))||void 0===e?void 0:e.downloadExtraFile.bind(N(this,E)),shareExtraFile:null===(t=N(this,E))||void 0===t?void 0:t.shareExtraFile.bind(N(this,E))}},e.prototype.blockStream=function(){var e=this;q.blockStream(N(this,i),function(){e.emit(Q.EventType.Play)})},e.prototype.discardFrame=function(e){var t,r=null===(t=N(this,i))||void 0===t?void 0:t.getVideoEl();null!=r&&(r.currentTime+=e)},e.prototype.remainBufferLength=function(){var e,t=null===(e=N(this,i))||void 0===e?void 0:e.getVideoEl();return null==t?0:F.remainBufferLength(t)},e.prototype.showHEVCQuality=function(e){var t=this;if(!F.isHardSupportHEVC()){var r=this.playUrlParser;if(null!=r)if(e)J.loadWASMDecoder().then(function(){null!=t.playUrlParser&&(U(t,v,!0),ae(t.ctrl.getCtrlUI(),t.playUrlParser,N(t,v)||F.wpd.SupportHEVC||F.isHardSupportHEVC()))}).catch(function(e){F.logger.error(e)});else{U(this,v,!1);var i=r.getQualityDesc();if((null==i?void 0:i.codec)!==F.CodecType.HEVC)return void ae(this.ctrl.getCtrlUI(),r,!1);var n=G.getHEVCDowngradeQn(i,r.getAVCQnCandidates());this.switchQuality(n)}}},e.prototype.destroy=function(e){var t,r;F.logger.info("live player destroy, holdLastFrame: "+String(e)),null===(t=N(this,i))||void 0===t||t.destroy(e),N(this,u)||(U(this,u,!0),this.emit($.Destroyed),null===(r=this.replay)||void 0===r||r.destroy(),N(this,T).call(this),this.ctrl.destroy(),N(this,g).destroy(),N(this,a).forEach(function(e){return e()}),U(this,a,[]))},e.prototype.switchQuality=function(e,t){var r,i,n=this;void 0===t&&(t=""),F.logger.info("switchQuality to "+e);var o=this.playUrlParser;if(null!=o){var l=o.getCurStreamInfo().host,a=o.getQualityDesc(e),u=o.getCurQuality(),c=o.getQualityDesc(u),p=o.getQualityDesc(null!==(r=N(this,d))&&void 0!==r?r:"0");if(null!=a&&null!=p&&null!=c){if(0===Number(F.getCookie("DedeUserID"))&&a.code>p.code)return F.logger.warn("user not login, reject switch quality"),this.emit(F.ExternalEventType.SwitchQualityNotLogin,{newQn:{qn:e,text:a.label},oldQn:{qn:c.value,text:c.label}}),!1;if(F.toast(t+"清晰度即将切换至"+a.label,this.container),U(this,s,{success:function(){F.toast(t+"清晰度已经切换至"+a.label,n.container),U(n,s,null),n.emit(F.ExternalEventType.SwitchQuality,e,c.value,o.getQnCandidates().map(function(e){var t=e.label;return{qn:e.value,desc:t}}))}}),c.code===a.code)return null===(i=this.playUrlParser)||void 0===i||i.useStream({codec:a.codec}),void this.reload();N(this,C).call(this,a.code).then(function(){var t,r,i=a.code===F.EQuality.Dolby?F.ProtocolType.HTTP_HLS:void 0;null===(t=n.playUrlParser)||void 0===t||t.useStream({codec:a.codec,protocol:i}),n.reload();var o=null===(r=n.playUrlParser)||void 0===r?void 0:r.getCurStreamInfo().host;B.default.operation(B.default.OperationCode.SwitchQuality,{fromQuality:u,toQuality:e,fromHost:l,toHost:o})}).catch(function(e){F.logger.error(e)})}else F.logger.error("switchQuality: quality parser error. "+JSON.stringify({targetQnDesc:a,curQnDesc:c,defQnDesc:p}))}},e.prototype.switchLine=function(e,t){var r,i,n,o=this;void 0===t&&(t=!0);var l=this.playUrlParser;if(null!=l){var a=l.getCurStreamInfo().host;t&&F.toast("线路即将切换至"+(null!==(i=null===(r=l.getLineCandidates().find(function(t){return t.value===e}))||void 0===r?void 0:r.label)&&void 0!==i?i:""),this.container),U(this,s,{success:function(){t&&F.toast("线路已经切换至"+l.getCurLineDesc().label,o.container),U(o,s,null),o.emit(F.ExternalEventType.SwitchLine,e)}}),null===(n=this.playUrlParser)||void 0===n||n.setCurLine(e);var u=l.getCurStreamInfo().host;B.default.operation(B.default.OperationCode.SwitchLine,{line:e,fromHost:a,toHost:u}),this.reload()}},e.prototype.capturePic=function(e,t){var r,n;return null!==(n=null===(r=N(this,i))||void 0===r?void 0:r.capturePic(e,t))&&void 0!==n?n:null},e}();function re(e,t,r){var i=this,n=!1,o=e.onRefresh(function(){var e,i;t.once(Q.EventType.FirstFrame,function(){n&&(F.toast("刷新成功",r),n=!1)}),F.toast("正在刷新",r),n=!0,!0===(null===(e=t.replay)||void 0===e?void 0:e.isReplay)&&(null===(i=t.replay)||void 0===i||i.returnLive()),t.tmShiftHandler(0),t.reload(),t.emit(F.ExternalEventType.Reload),B.default.operation(B.default.OperationCode.Refresh)}),l=e.onChange(function(e,r){return k(i,void 0,void 0,function(){return M(this,function(i){return"quality"===e?t.switchQuality(r):"line"===e&&t.switchLine(r),le(e,r),[2]})})});return function(){o(),l()}}function ie(e,t){var r=Date.now()/1e3-e-performance.now()/1e3,i=window.setInterval(function(){t.time={value:F.formatTime(performance.now()/1e3+r),tips:"直播持续时间"}},1e3);return function(){clearInterval(i)}}function ne(e){var t=[],r=e.getVideoEl(),i=0;return F.logger.info("start monitor buffer length"),e.on(Q.EventType.VideoInfo,function(e){var n=e.realtimeInfo;if(!r.paused){var o=n.videoBufferLength;(o>10||i===r.currentTime&&o>5)&&(r.currentTime+=o/2,F.logger.warn("auto discard frame, current time: "+r.currentTime),t.length<3&&((t=t.filter(function(e){return performance.now()-e<5e3})).push(performance.now()),3===t.length&&B.default.custom(B.default.CustomCode.AutoDiscardFrame,null,{extFields:"all"}))),i=r.currentTime}})}function oe(e,t){if(null===t)return function(){};if(!F.ua.isChrome()&&!F.ua.isEdg())return function(){};var r=t.auto_sync_enable,i=t.auto_sync_high_speed,n=t.auto_sync_low_speed,o=t.auto_sync_max_threshold,l=t.auto_sync_min_threshold;return 1!==r?function(){}:(F.logger.info("live player start auto sync video progress"),e.on(Q.EventType.VideoInfo,function(t){var r=1e3*t.realtimeInfo.videoBufferLength;if(!(r<0||isNaN(r))){var a=e.getVideoEl(),s=1;r<l?s=n:r>o&&(s=i),(s<=0||s>2)&&(s=1),s!==a.playbackRate&&(a.playbackRate=s)}}))}function le(e,t){"danmaku"===e?B.default.operation(B.default.OperationCode.Danmaku,V({},t)):"volume"===e?!0===t.disabled?B.default.operation(B.default.OperationCode.Mute):B.default.operation(B.default.OperationCode.Volume,{value:t.value}):"playStatus"===e?!0===t?B.default.operation(B.default.OperationCode.Play):B.default.operation(B.default.OperationCode.Pause):"fullScreenStatus"===e?B.default.operation(B.default.OperationCode.FullScreen,{value:t}):"webFullScreenStatus"===e&&B.default.operation(B.default.OperationCode.WebFullScreen,{value:t})}function ae(e,t,r){var i,n,o,l={list:null!==(i=t.getLineCandidates())&&void 0!==i?i:[],value:null!==(n=t.getCurLine())&&void 0!==n?n:0};e.line=l;var a=t.getQnCandidates();r||(a=t.getAVCQnCandidates());var s={list:a,value:null!==(o=t.getCurQuality())&&void 0!==o?o:"0"};e.quality=s}function se(e,t,r){F.logger.debug("listen sticker SEI");var i=null,n=!1,o=t.on(F.ExternalEventType.SEIParseData,function(e,t){e===F.SEIType.LIVE_SEI_CHANNEL&&(n||(n=!0,i=new j.default(r)),null==i||i.onSei(t))}),l=e.on(Q.EventType.MetaData,function(e){n&&(F.logger.info("destroy sticker when metadata"),null==i||i.destroy(),n=!1)}),a=0,s=t.ctrl.onChange(function(e,t){"webFullScreenStatus"!==e&&"fullScreenStatus"!==e||(clearTimeout(a),a=window.setTimeout(function(){null==i||i.calcDisplayInfo(),null==i||i.batchUpdateStickerElement()},"webFullScreenStatus"===e?10:300))}),u=e.on(Q.EventType.VideoInfo,function(e){null==i||i.onVideoInfo({width:e.mediaInfo.width,height:e.mediaInfo.height})});t.once($.Destroyed,d),e.once(Q.EventType.Destroyed,d);var c=!1;function d(){c||(c=!0,F.logger.info("destroy sticker..."),clearTimeout(a),null==i||i.destroy(),s(),o(),l(),u())}}function ue(e,t){var r=t.userId,i=t.ownerId,n=t.isMobile,o=new x.default(e);return(r===i||n)&&o.setCurP2PType(ee[o.getCurP2PType()]),o}exports.LivePlayer=te,t=new WeakMap,r=new WeakMap,i=new WeakMap,n=new WeakMap,o=new WeakMap,l=new WeakMap,a=new WeakMap,s=new WeakMap,u=new WeakMap,c=new WeakMap,d=new WeakMap,p=new WeakMap,h=new WeakMap,y=new WeakMap,f=new WeakMap,v=new WeakMap,g=new WeakMap,m=new WeakMap,E=new WeakMap,P=new WeakMap,S=new WeakMap,w=new WeakMap,T=new WeakMap,C=new WeakMap,I=new WeakMap,_=new WeakMap,b=new WeakMap,L=new WeakMap;var ce=function(e,t,r,i,n){var o=[];if(e.getCurStreamInfo().qualityDesc.some(function(e){var t;return!0===(null===(t=e.attr_desc)||void 0===t?void 0:t.some(function(e){return"panorama"===e.attr_name}))})){var l=Y.showPanoramaTip(t,r);if(null!=l){n.show();var a=setTimeout(function(){n.hide()},1e4);o.push(l,function(){clearTimeout(a)});var s=n.onChange(function(e,t){"qualityPanelShow"===e&&!0===t&&(l(),s(),clearTimeout(a))})}}if("panorama"===e.getCurStreamInfo().curAttrName){var u=new Y.Panorama(t,i,function(){F.toast("资源加载失败，无法进行全景交互",t)});o.push(u.destroy)}return o},de=F.throttle(function(e){B.default.custom(B.default.CustomCode.SEILatency,{sei_latency:e},{extFields:["p2pType","sHost","sProtocol","sCodec","quality","sName"],sampleRate:.01})},6e4),pe=F.debounce(function(e){return e()},6e4);
})()