/**
 * id: YQ89
 * path: ./biz-common
 */

function(require,module,exports) {
"use strict";var e,r,o=this&&this.__awaiter||function(e,r,o,t){return new(o||(o=Promise))(function(n,i){function a(e){try{u(t.next(e))}catch(r){i(r)}}function l(e){try{u(t.throw(e))}catch(r){i(r)}}function u(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o(function(e){e(r)})).then(a,l)}u((t=t.apply(e,r||[])).next())})},t=this&&this.__generator||function(e,r){var o,t,n,i,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(i){return function(l){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,t&&(n=2&i[0]?t.return:i[0]?t.throw||((n=t.return)&&n.call(t),0):t.next)&&!(n=n.call(t,i[1])).done)return n;switch(t=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,t=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){a.label=i[1];break}if(6===i[0]&&a.label<n[1]){a.label=n[1],n=i;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(i);break}n[2]&&a.ops.pop(),a.trys.pop();continue}i=r.call(e,a)}catch(l){i=[6,l],t=0}finally{o=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,l])}}},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.disableDanmaku=exports.dmVisualVibrate=exports.pressToOpenVideoInfoListener=exports.pause10SecBlockStream=exports.getUserId=exports.updateDanmakuSetting=exports.createContextmenuHandler=exports.ajaxWatcher=exports.initRoomInfoOrBlock=exports.loadRoomInfo=exports.initPlayer=exports.commonLogInfo=exports.downloadFile=exports.isSupported=exports.PlayerEnv=exports.ENV=void 0;var i,a=require("@bilibili-live/web-player-common"),l=n(require("@bilibili-live/web-player-track")),u=require("./ui-components/error-panel"),c=require("@bilibili-live/web-player"),s=require("./vibrate/vibrate_task");function d(){var e;return null!=Object.entries&&null!=Element.prototype.prepend&&("fetch"in window&&"ReadableStream"in window&&Boolean(null===(e=window.MediaSource)||void 0===e?void 0:e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'))||a.ua.isIOS())}function p(r,o){try{var t=document.createElement("a");t.download=o,t.style.display="none";var n=new Blob([r]);t.href=window.URL.createObjectURL(n),document.body.appendChild(t),t.click(),document.body.removeChild(t)}catch(e){a.logger.error("Failed to download file")}}function f(e){a.logger.info(e+" version: "+exports.ENV.VERSION+", current date: "+(new Date).toLocaleDateString()+", build time: "+exports.ENV.BUILD_TIME),a.logger.info("user agent: "+navigator.userAgent),setTimeout(function(){a.ajax("/xlive/web-room/v1/index/getIpInfo").then(function(e){a.logger.info("client ip info: "+JSON.stringify(e))}).catch(a.logger.error)},100)}function v(e,r){var o=a.uuid(),t=g();return a.logger.info("userId: "+t),l.default.initStaticInfo({uvid:o,uid:t,version:r+exports.ENV.VERSION,roomId:e}),a.userSetting.init(t),d()||(l.default.error(l.default.ErrorCode.UnsupportedPlayer,"UnsupportedPlayer"),a.logger.error("Unsupported Player")),{userId:t,uvid:o}}function m(e,r){return o(this,void 0,Promise,function(){return t(this,function(o){switch(o.label){case 0:return null==r?[3,2]:[4,r(e)];case 1:return[2,o.sent()];case 2:return[4,new Promise(function(r,o){a.ajax("//api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo?room_id="+e.roomId+"&protocol=0,1&format=0,1,2&codec=0,1&qn="+e.qn+"&platform="+(e.isMobile?"html5":"web")+"&ptype=8&dolby=5"+(e.isMobile?"":"&panorama=1"),{handleRes:r}).catch(o)})];case 3:return[2,o.sent()]}})})}function y(e,r,n){var i=e.roomId,l=e.isMobile;return o(this,void 0,Promise,function(){var e,o,c;return t(this,function(t){switch(t.label){case 0:return[4,m({roomId:i,qn:0,isMobile:l},n)];case 1:if(e=t.sent(),o=e.code,c=e.data,o===a.ApiErrorCode.AreaBlock)throw u.createErrorPanel(r,a.ApiErrorCode.AreaBlock,"Sorry, bilibili is currently not available in your country according to copyright restrictions<br/>非常抱歉，根据版权方要求，您所在的地区无法观看本直播"),new Error("RoomAreaBlock");return[2,c]}})})}function b(e,r){var o=r.duration,t=void 0===o?0:o,n=r.errMsg,i=void 0===n?"ApiError":n,a=r.apiUrl,u=void 0===a?"":a;"apiBizErr"===e?l.default.error(l.default.ErrorCode.ApiBiz,i,{apiUrl:u,extFields:[]}):"requestErr"===e?l.default.error(l.default.ErrorCode.ApiRequest,i,{apiUrl:u,extFields:[],sampleRate:.01}):"responseErr"===e?l.default.error(l.default.ErrorCode.ApiResponse,i,{apiUrl:u,extFields:[]}):"perf"===e&&l.default.perf(l.default.PerfCode.Api,t,{params:{apiUrl:u},extFields:[],sampleRate:.01})}function h(e,r){return{handleLogger:function(r){var o,t=a.logger.dump();switch(r){case"copy":return void(null===(o=navigator.clipboard)||void 0===o||o.writeText(t).catch(function(){}));case"download":return void p(t,"Bilibili-Live-HTML5-Player-EventLog-"+Date.now()+".txt");case"show":e.show()}},handleVideoInfo:function(){r.show()}}}function x(e,r){var o={area:"danmakuArea",fontScale:"fontSize"},t=function(e){return e/100},n={opacity:t,fontScale:t,density:t,area:function(e){return e/4*100}};Object.entries(e).map(function(e){var r,t,i=e[0],a=e[1];return[null!==(r=o[i])&&void 0!==r?r:i,(null!==(t=n[i])&&void 0!==t?t:function(e){return e})(a)]}).forEach(function(e){var o,t=e[0],n=e[1];"display"===t?r[n?"show":"hide"]():r.set(((o={})[t]=n,o))})}function g(){return Number(a.getCookie("DedeUserID"))}function w(e,r){var o=0,t=!1;a.mediaAction.on("play",function(){n()}),a.mediaAction.on("pause",function(){u()});var n=function(){var n,i;if(clearTimeout(o),t){t=!1;var l=e instanceof c.LivePlayer&&!0===(null===(n=e.replay)||void 0===n?void 0:n.isReplay);a.logger.info("reload when blocked stream, isReplay?: "+String(l)),l?null===(i=e.replay)||void 0===i||i.reload():(e.destroy(),r.reload().catch(function(e){a.logger.error(e)}))}},i=e.on(c.VideoEventType.Play,n),l=e.ctrl.onChange(function(e,r){"playStatus"===e&&(r?n():u())}),u=function(){o=window.setTimeout(function(){a.logger.info("block stream because paused 10 sec"),t=!0,e.blockStream()},1e4)};return function(){i(),l(),clearTimeout(o),t=!1,a.mediaAction.destroy()}}function E(e){var r=[],o=function(o){r.push(performance.now()),(r=r.filter(function(e){return performance.now()-e<50})).length>=2&&(r=[],e.dispatchEvent(new MouseEvent("contextmenu",{clientX:o.changedTouches[0].clientX,clientY:o.changedTouches[0].clientY})))};return e.addEventListener("touchend",o),function(){e.removeEventListener("touchend",o)}}exports.ENV={VERSION:null!==(e="3.6.134")&&void 0!==e?e:"unknown",BUILD_TIME:null!==(r="2023/8/22 上午11:53:49")&&void 0!==r?r:"unknown",NODE_ENV:"production"},function(e){e.Activity="A",e.Room="R",e.Home="H",e.Mobile="M"}(i=exports.PlayerEnv||(exports.PlayerEnv={})),exports.isSupported=d,exports.downloadFile=p,exports.commonLogInfo=f,exports.initPlayer=v,exports.loadRoomInfo=m,exports.initRoomInfoOrBlock=y,exports.ajaxWatcher=b,exports.createContextmenuHandler=h,exports.updateDanmakuSetting=x,exports.getUserId=g,exports.pause10SecBlockStream=w,exports.pressToOpenVideoInfoListener=E;var I=function(e,r){var o=null;return e.on(a.ExternalEventType.SEIParseData,function(t,n,i){if(t===a.SEIType.B_LIVE_VIBRATION){var l=e.getVideoEl();null!=l&&(null==o&&(o=new s.VibrateTask(l,r)),o.input(n,i))}}),e.on(c.VideoEventType.Destroyed,function(){null==o||o.destroy(),o=null}),e.on(c.VideoEventType.WaitStart,function(){null==o||o.webXInputSetState(0,0)}),function(){null==o||o.destroy(),o=null}};function S(e){var r;null!=e.ctrl&&(e.ctrl.getCtrlUI().ctrlItemVisibility.danmaku=!1),null===(r=e.danmakuBiz)||void 0===r||r.hide()}exports.dmVisualVibrate=I,exports.disableDanmaku=S;
}