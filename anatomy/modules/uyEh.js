/**
 * id: uyEh
 * path: @bilibili-live/web-player-danmaku
 */

(function(require,module,exports) {
"use strict";var e,t,n,i,o,a,r,l,s,u,c,d,h,f,p,m=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,a){function r(e){try{s(i.next(e))}catch(t){a(t)}}function l(e){try{s(i.throw(e))}catch(t){a(t)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,l)}s((i=i.apply(e,t||[])).next())})},v=this&&this.__generator||function(e,t){var n,i,o,a,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(o=2&a[0]?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(l){a=[6,l],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},w=this&&this.__classPrivateFieldSet||function(e,t,n){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,n),n},y=this&&this.__classPrivateFieldGet||function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},k=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DmType=void 0,require("requestidlecallback-polyfill");var g,b=k(require("@bilibili-live/live-danmaku-engine-v2")),M=k(require("./mask-decoder")),x=require("@bilibili-live/web-player-common"),E=x.isWebPSupported(),T=150;!function(e){e[e.Text=0]="Text",e[e.Emoji=1]="Emoji",e[e.Voice=2]="Voice"}(g=exports.DmType||(exports.DmType={}));var W="web-player-danmaku",_="danmaku-item-container",P=function(){function k(k,b){var x=this;this.container=k,this.opts=b,e.set(this,void 0),t.set(this,void 0),n.set(this,[]),i.set(this,!1),o.set(this,void 0),a.set(this,void 0),r.set(this,void 0),l.set(this,void 0),s.set(this,null),u.set(this,[]),c.set(this,void 0),d.set(this,void 0),h.set(this,0),f.set(this,function(e){var n=null!=e.dm_v2?{mode:e.mode,dm:e.dm_v2}:void 0;e.dmType===g.Emoji?x.getEmoticonInfo(e).then(function(i){var o=i.html,a=i.emojiRatio;e=Object.assign({},e,{html:o,emojiRatio:a}),y(x,t).add(e,n)}).catch(function(e){console.error(e)}):y(x,t).add(e,n)}),p.set(this,function(){w(x,s,window.requestIdleCallback(function(e){if(null!=e.timeRemaining)for(var t=function(){var e=y(x,n).shift(),t=100*y(x,u).length,i=setTimeout(function(){y(x,f).call(x,e),y(x,u).shift()},t);y(x,u).push(i)};(e.timeRemaining()>0||e.didTimeout)&&y(x,n).length>0&&y(x,u).length<10;)t();if(y(x,n).length>0)return y(x,p).call(x);null!=y(x,s)&&(window.cancelIdleCallback(y(x,s)),w(x,s,null))},{timeout:1e3}))}),this.parseEmoticon=function(e,t){return m(x,void 0,Promise,function(){var n,i;return v(this,function(o){switch(o.label){case 0:return!1,e.dmType!==g.Emoji?[3,2]:(n=new Image,i=t.url,n.style.width="100%",n.style.height="100%",n.src=i+(E?"@56h.webp":"@56h.png"),[4,new Promise(function(e){n.onerror=function(){e(!0)},n.onload=function(){e(!1)}})]);case 1:return o.sent()?[2,""]:[2,n.outerHTML];case 2:return[2,""];case 3:return[2]}})})},this.getEmoticonInfo=function(e){return m(x,void 0,Promise,function(){var t,n,i,o;return v(this,function(a){switch(a.label){case 0:return t=null!==(o=e.emoticonOptions)&&void 0!==o?o:{width:1,height:1,url:"",emoji:""},[4,this.parseEmoticon(e,t)];case 1:return n=a.sent(),i=e.dmType===g.Emoji?Number((t.width/t.height).toFixed(1)):1,[2,{html:n,emojiRatio:i}]}})})},this.add=function(e,i){if(void 0===i&&(i=!1),null!=y(x,t)){if(i)return y(x,f).call(x,e);y(x,n).length>20&&y(x,n).shift(),y(x,n).push(e),null==y(x,s)&&y(x,p).call(x)}},this.onPlay=function(e){w(x,o,e)},this.onPause=function(e){w(x,a,e)},this.offPlay=function(){w(x,o,void 0)},this.offPause=function(){w(x,a,void 0)},this.onSelect=function(e){x.offSelect(),w(x,r,e),w(x,l,function(n){var i,o=x.container.getBoundingClientRect(),a=Number(null!==(i=getComputedStyle(document.documentElement).zoom)&&void 0!==i?i:1),r=n.clientX/a-o.left,l=n.clientY/a-o.top,s=y(x,t).searchAreaDanmaku(r,l);s.length>0&&(e(s.map(function(e){return e.textData})),n.preventDefault())}),x.container.addEventListener("contextmenu",y(x,l),!0)},this.offSelect=function(){var e;null!=y(x,l)&&(null===(e=x.container)||void 0===e||e.removeEventListener("contextmenu",y(x,l),!0),w(x,l,void 0))},this.play=function(){var e;y(x,i)||(w(x,i,!0),null===(e=y(x,t))||void 0===e||e.play(),null!=y(x,o)&&y(x,o).call(x))},this.pause=function(){var e;y(x,i)&&(w(x,i,!1),null===(e=y(x,t))||void 0===e||e.pause(),null!=y(x,a)&&y(x,a).call(x))},this.setRenderType=function(n){var i;null===(i=y(x,t))||void 0===i||i.setType(n),null!=y(x,e)&&x.setBackGroundImage(y(x,e)),null!=y(x,l)&&(x.offSelect(),null!=y(x,r)&&x.onSelect(y(x,r)))},this.resize=function(){var e;if(null==y(x,t))return x;var n=y(x,t).config.container;return null!=n&&(n.style.width=y(x,c).clientWidth+"px",n.style.height=y(x,c).clientHeight+"px",null===(e=y(x,t))||void 0===e||e.resize()),x},this.show=function(){var e;null===(e=y(x,t))||void 0===e||e.visible(!0)},this.hide=function(){var e;null===(e=y(x,t))||void 0===e||e.visible(!1)},this.setBackGroundImage=function(t){if(null==y(x,c))throw new Error("danmakuWrapNode must be HTMLElement");t!==y(x,e)&&w(x,e,t),y(x,c).style.backgroundImage="url("+t+")",y(x,c).style.backgroundRepeat="no-repeat",y(x,c).style.backgroundPosition="center",y(x,c).style.backgroundSize="contain"},this.set=function(e){var n=y(x,t);if(null!=n)for(var i in e){var o=e[i];switch(i){case"type":x.setRenderType(o);break;case"backgroundImage":x.setBackGroundImage(o);break;case"maxCount":i="danmakuNumber",n.option(i,o);break;default:n.option(i,o)}}},this.clear=function(){var e;null===(e=y(x,t))||void 0===e||e.clear()},this.destroy=function(){var e;y(x,c).remove(),null===(e=y(x,t))||void 0===e||e.destroy(),w(x,t,null),y(x,d).destroy(),null!=y(x,s)&&(window.cancelIdleCallback(y(x,s)),w(x,s,null)),w(x,n,[]),y(x,u).forEach(function(e){return window.clearTimeout(e)}),window.removeEventListener("resize",x.resize),cancelAnimationFrame(y(x,h))},this.addMaskSVG=function(e){y(x,d).input(e[1],e[3])},this.clearMask=function(){y(x,d)._masks=[]},this.addMaskToWrap=function(e){var t=y(x,c),n=y(x,d);cancelAnimationFrame(y(x,h));w(x,h,window.requestAnimationFrame(function i(o){o>performance.now()-5&&n.onUpdateMask(e,t),w(x,h,window.requestAnimationFrame(i))}))},this.fullscreenDM=function(){y(x,c).style.position="fixed"},this.offsetDM=function(e){y(x,c).style.transform="translate3d("+e+"px, "+e+"px, 0)"},w(this,e,null==b?void 0:b.backgroundImage),w(this,c,document.createElement("div")),y(this,c).classList.add(W),y(this,c).style.cssText="\n        width: 100%;\n        height: 100%;\n        position: relative;\n        top: 0;\n        left: 0;\n        z-index: 8;\n        pointer-events: none;\n      ",k.appendChild(y(this,c)),this.initialize(),w(this,d,new M.default)}return k.prototype.initialize=function(){var n,i,o=document.createElement("div");o.classList.add(_);var a=document.createElement("style");a.innerHTML="\n        ."+W+" ."+_+"{\n          width: "+y(this,c).clientWidth+"px;\n          height: "+y(this,c).clientHeight+"px;\n          position: relative;\n          overflow: hidden;\n        }",document.getElementsByTagName("HEAD")[0].appendChild(a),y(this,c).appendChild(o),w(this,t,new b.default({container:o,isLive:!0,type:"div",opacity:1,fontSize:1,duration:6,danmakuArea:100,danmakuNumber:T,isRecycling:!0,isMobile:null!==(i=null===(n=this.opts)||void 0===n?void 0:n.isMobile)&&void 0!==i&&i})),null!=y(this,e)&&this.setBackGroundImage(y(this,e)),window.addEventListener("resize",this.resize)},k.prototype.closeMask=function(e){cancelAnimationFrame(y(this,h)),e||y(this,c).style.removeProperty("-webkit-mask-image")},k.prototype.getDanmakuElement=function(){return y(this,c)},k}();e=new WeakMap,t=new WeakMap,n=new WeakMap,i=new WeakMap,o=new WeakMap,a=new WeakMap,r=new WeakMap,l=new WeakMap,s=new WeakMap,u=new WeakMap,c=new WeakMap,d=new WeakMap,h=new WeakMap,f=new WeakMap,p=new WeakMap,exports.default=P;
})()