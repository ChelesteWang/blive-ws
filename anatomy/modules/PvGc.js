/**
 * id: PvGc
 * path: ./round-player
 */

function(require,module,exports) {
"use strict";var t,e,n,i,r,o,a,s,l,u,c,d=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function a(t){try{l(i.next(t))}catch(e){o(e)}}function s(t){try{l(i.throw(t))}catch(e){o(e)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(a,s)}l((i=i.apply(t,e||[])).next())})},h=this&&this.__generator||function(t,e){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},f=this&&this.__classPrivateFieldSet||function(t,e,n){if(!e.has(t))throw new TypeError("attempted to set private field on non-instance");return e.set(t,n),n},p=this&&this.__classPrivateFieldGet||function(t,e){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)},v=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RoundPlayer=exports.NonRoundStatus=void 0;var y,m=require("./dash-player"),b=v(require("../common/controller")),E=require("@bilibili-live/web-player-common"),w=require("../common/utils"),g=require("../common/connects"),x=v(require("@bilibili-live/web-player-track")),P=require("@bilibili-live/web-player-video");!function(t){t[t.Preround=-1]="Preround",t[t.Failed=-2]="Failed",t[t.Nonenabled=-3]="Nonenabled"}(y=exports.NonRoundStatus||(exports.NonRoundStatus={}));var k=function(){function v(v,k){var T=this;t.set(this,""),e.set(this,null),n.set(this,void 0),i.set(this,void 0),r.set(this,new E.EventBus),this.on=p(this,r).on,this.emit=p(this,r).emit,o.set(this,[]),a.set(this,null),s.set(this,""),l.set(this,!1),this.getVideoEl=function(){var t;return null===(t=p(T,e))||void 0===t?void 0:t.getVideoEl()},this.getPlayerInfo=function(){var n,i;return{guid:p(T,t),playingStatus:!(null!==(i=null===(n=p(T,e))||void 0===n?void 0:n.getVideoEl().paused)&&void 0!==i&&i),playSrc:p(T,s),quality:"0",qualityCandidates:[]}},this.play=function(){var t;null===(t=p(T,e))||void 0===t||t.play().catch(function(){})},this.pause=function(){var t;null===(t=p(T,e))||void 0===t||t.pause()},this.volume=function(t){var n;null===(n=p(T,e))||void 0===n||n.volume(t)},this.mute=function(t){var n;null===(n=p(T,e))||void 0===n||n.mute(t)},u.set(this,function(){return d(T,void 0,Promise,function(){var v,b,k,T,S,M,W,I,V,C=this;return h(this,function(q){switch(q.label){case 0:return p(this,l)?[2]:(null===(I=p(this,e))||void 0===I||I.destroy(),v=E.loading(p(this,n)),[4,_(p(this,i).roomId)]);case 1:return b=q.sent(),v(),b.cid===y.Failed?[2]:b.cid<=0?(k=void 0,b.cid===y.Nonenabled&&(k=x.default.ErrorCode.RoomUnSettingRound),E.logger.warn("exit round cause: "+y[b.cid]),this.emit("failed",b.cid,b.play_time,k),this.destroy(),[2]):(this.emit(E.ExternalEventType.StartPlayRound,b),[4,R(b.cid,b.bvid,p(this,i).userId)]);case 2:if(null==(T=q.sent().dash))throw x.default.error(x.default.ErrorCode.RoomRoundNotExistDash,"dash url is not exist"),new Error("dash url is not exist");return f(this,e,new m.DashPlayer),p(this,e).init(T,0===p(this,i).userId?0:80).then(function(){var t;null===(t=p(C,e))||void 0===t||t.seek(b.play_time).catch(function(t){E.logger.error(t)})}).catch(function(t){E.logger.error(t)}),p(this,l)?[2]:(f(this,t,E.uuid()),f(this,s,JSON.stringify(T)),p(this,o).forEach(function(t){return t()}),f(this,o,[]),p(this,o).push(p(this,c).call(this,b.title),g.connectUIandVideo(this.ctrl,p(this,e)),g.connectVideoLoading(p(this,e),p(this,n),p(this,a)),g.connectVideoPip(p(this,e),this.ctrl),g.connectMirror(p(this,e),this.ctrl),E.EventBus.forwardEvent(p(this,e),p(this,r),[P.EventType.Play,P.EventType.Pause,P.EventType.LoadStart,P.EventType.MetaData,P.EventType.VideoInfo,P.EventType.FirstFrame,P.EventType.WaitEnd,P.EventType.WaitStart])),p(this,e).once(P.EventType.Destroyed,function(){C.emit(P.EventType.Destroyed)}),S=null,M=function(){return d(C,void 0,Promise,function(){var t;return h(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t=E.loading(p(this,n)),[4,w.backoffById(b.bvid,4)];case 1:return e.sent(),null==t||t(),[3,3];case 2:return e.sent(),null==t||t(),[3,3];case 3:return p(this,u).call(this).catch(function(t){E.logger.error(t),x.default.error(x.default.ErrorCode.RoomEnterRoundError,t)}),null==S||S.remove(),[2]}})})},p(this,e).once(P.EventType.Ended,M),p(this,e).once(P.EventType.Error,M),W=p(this,e).getVideoEl(),p(this,e).once(P.EventType.FirstFrame,function(){S=P.checkVideoRate(W)}),null===(V=p(this,e))||void 0===V||V.removeVideoEl(),p(this,n).appendChild(W),[2])}})})}),c.set(this,function(t){var e,i="web-player-round-title";null===(e=document.querySelector("."+i))||void 0===e||e.remove();var r=document.createElement("div");return r.classList.add(i),r.textContent=t,r.style.cssText="\n      z-index: 2;\n      position: absolute;\n      right: 20px;\n      bottom: 20px;\n      pointer-events: none;\n      color: #aaa;\n      font-size: 14px;\n    ",p(T,n).appendChild(r),function(){r.remove()}}),this.blockStream=function(){w.blockStream(p(T,e),function(){T.emit(P.EventType.Play)})},E.logger.info("enter round"),f(this,n,v),f(this,i,k),this.ctrl=new b.default(p(this,n),{userId:p(this,i).userId,isMobile:!1,enableCtrlUI:p(this,i).enableCtrlUI}),p(this,u).call(this).catch(function(t){E.logger.error(t),x.default.error(x.default.ErrorCode.RoomEnterRoundError,t)}),this.ctrl.onRefresh(function(){p(T,u).call(T).catch(function(t){E.logger.error(t),x.default.error(x.default.ErrorCode.RoomEnterRoundError,t)})})}return v.prototype.setTitlePageImg=function(t){f(this,a,t)},v.prototype.capturePic=function(t,n){var i,r;return null!==(r=null===(i=p(this,e))||void 0===i?void 0:i.capturePic(t,n))&&void 0!==r?r:null},v.prototype.destroy=function(t){var n;void 0===t&&(t=!1),p(this,l)||(f(this,l,!0),E.logger.info("round player destroy, holdLastFrame: "+String(t)),null===(n=p(this,e))||void 0===n||n.destroy(t),p(this,o).forEach(function(t){return t()}),f(this,o,[]),this.ctrl.destroy(),p(this,r).destroy())},v}();function _(t){return d(this,void 0,Promise,function(){var e;return h(this,function(n){switch(n.label){case 0:return[4,E.ajax("/live/getRoundPlayVideo?room_id="+t+"&a="+Date.now()+"&type=flv")];case 1:if(e=n.sent(),Object.values(y).includes(e.cid))return[2,{play_time:e.play_time,cid:e.cid,bvid:e.bvid,title:e.title}];if(e.cid<=0)throw new Error("getRoundPlayVideo result parse failed: "+JSON.stringify(e));return[2,{play_time:e.play_time,cid:e.cid,bvid:e.bvid,title:e.title}]}})})}exports.RoundPlayer=k,t=new WeakMap,e=new WeakMap,n=new WeakMap,i=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap,l=new WeakMap,u=new WeakMap,c=new WeakMap;var R=function(t,e,n){return d(void 0,void 0,Promise,function(){return h(this,function(n){switch(n.label){case 0:return[4,E.ajax("https://api.bilibili.com/x/player/playurl?cid="+t+"&bvid="+e+"&fnval=16&platform=web")];case 1:return[2,n.sent()]}})})};
}