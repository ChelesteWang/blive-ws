/**
 * id: xqO8
 * path: ./replay
 */

(function(require,module,exports) {
"use strict";var e,t,i,n,a,s,l,r,o,c,u,d,h,p,f,v,m,y,w,g,b,k,M,L,E,W,C,S,P,_,R,I,H,D,x,T,A,B,O=this&&this.__assign||function(){return(O=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var a in t=arguments[i])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},N=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(a,s){function l(e){try{o(n.next(e))}catch(t){s(t)}}function r(e){try{o(n.throw(e))}catch(t){s(t)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(l,r)}o((n=n.apply(e,t||[])).next())})},q=this&&this.__generator||function(e,t){var i,n,a,s,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return l.label++,{value:s[1],done:!1};case 5:l.label++,n=s[1],s=[0];continue;case 7:s=l.ops.pop(),l.trys.pop();continue;default:if(!(a=(a=l.trys).length>0&&a[a.length-1])&&(6===s[0]||2===s[0])){l=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){l.label=s[1];break}if(6===s[0]&&l.label<a[1]){l.label=a[1],a=s;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(s);break}a[2]&&l.ops.pop(),l.trys.pop();continue}s=t.call(e,l)}catch(r){s=[6,r],n=0}finally{i=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},U=this&&this.__classPrivateFieldSet||function(e,t,i){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,i),i},j=this&&this.__classPrivateFieldGet||function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},F=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var V=F(require("./replay.less")),G=require("@bilibili-live/web-player-common"),Y=require("@bilibili-live/web-player-socket"),z=require("../common/controller"),X=F(require("@bilibili-live/web-player-track")),$=function(){return function(F,$,J,K){var Q=this;this.ctrl=K,e.set(this,3600),t.set(this,300),i.set(this,document.createElement("div")),n.set(this,document.createElement("div")),a.set(this,document.createElement("div")),s.set(this,document.createElement("div")),l.set(this,document.createElement("div")),r.set(this,document.createElement("div")),o.set(this,null),c.set(this,new Map),u.set(this,0),d.set(this,void 0),h.set(this,void 0),p.set(this,[]),f.set(this,[]),v.set(this,0),m.set(this,{}),this.isReplay=!1,y.set(this,new G.EventBus),this.on=j(this,y).on,this.emit=j(this,y).emit,w.set(this,0),g.set(this,!0),b.set(this,!1),this.bakState={},k.set(this,!1),this.init=function(){var e,i=Q.ctrl.onChange(function(e,t){return N(Q,void 0,void 0,function(){return q(this,function(i){return"show"===e&&(this.changeReplayStyle(t),t||this.removeMouseMoveListener()),[2]})})}),a=j(Q,M).call(Q);a.addEventListener("touchstart",j(Q,W)),a.addEventListener("mousedown",j(Q,L));var s=0,l=function(){return N(Q,void 0,Promise,function(){var e,t=this;return q(this,function(i){switch(i.label){case 0:return[4,j(this,T).call(this)];case 1:return i.sent()?(j(this,B).call(this),null===(e=j(this,o))||void 0===e||e.appendChild(a),s=window.setInterval(function(){j(t,D).call(t)},1e3),window.addEventListener("message",j(this,x)),[2]):[2]}})})};if(Date.now()/1e3-j(Q,u)>=j(Q,t))l().catch(function(e){G.logger.error(e)});else{var r=window.setInterval(function(){Date.now()/1e3-j(Q,u)>=j(Q,t)&&(l().catch(function(e){G.logger.error(e)}),clearInterval(r))},5e3);j(Q,p).push(function(){return clearInterval(r)})}var c=null===(e=j(Q,o))||void 0===e?void 0:e.getElementsByClassName("web-player-controller-wrap"),d=Date.now();null!=c&&c[0].classList.add("web-player-controller-"+d.toString()),j(Q,p).push(i,function(){clearInterval(s)},Q.ctrl.on(z.ControllerEventType.BottomDistanceChange,function(e){j(Q,n).style.bottom=e+"px"}))},this.removeReplay=function(){j(Q,p).forEach(function(e){return null==e?void 0:e()}),U(Q,p,[]),window.removeEventListener("message",j(Q,x)),j(Q,n).remove(),j(Q,n).removeEventListener("mousedown",j(Q,L))},this.removeHighlight=function(e){var t=!1;return j(Q,c).forEach(function(i,n){i.tag_id===e&&(j(Q,c).delete(n),t=!0,n.remove())}),t},this.handleHighlight=function(e){Q.removeHighlight(e.tag_id),"ADD"===e.type&&j(Q,H).call(Q,e),"DEL_ALL"===e.type&&j(Q,c).forEach(function(e,t){j(Q,c).delete(t),t.remove()})},this.changeReplayStyle=function(e){e?(j(Q,i).classList.remove(V.default.replayHidden),j(Q,i).classList.add(V.default.replayShow),j(Q,l).classList.remove(V.default.progressHidden),j(Q,l).classList.add(V.default.progressShow),j(Q,a).style.display="block",j(Q,s).classList.add(V.default.webPlayerReplayHighlightsShow),j(Q,s).classList.remove(V.default.webPlayerReplayHighlightsHidden)):(j(Q,i).classList.remove(V.default.replayShow),j(Q,i).classList.add(V.default.replayHidden),j(Q,l).classList.remove(V.default.progressShow),j(Q,l).classList.add(V.default.progressHidden),j(Q,a).style.display="none",j(Q,s).classList.remove(V.default.webPlayerReplayHighlightsShow),j(Q,s).classList.add(V.default.webPlayerReplayHighlightsHidden))},this.setProgress=function(e){j(Q,r).style.width=e,j(Q,a).style.left=e},this.removeMouseMoveListener=function(e){var t,i;if(null===(t=j(Q,o))||void 0===t||t.removeEventListener("mousemove",j(Q,E)),null!=e){var n=j(Q,_).call(Q,j(Q,a).style.left);if(Q.isReplay=0!==n,0===j(Q,v)){var s=Q.ctrl.getCtrlUI();U(Q,g,Boolean(null===(i=s.danmaku)||void 0===i?void 0:i.display))}U(Q,v,n),Q.reload(n),window.removeEventListener("mouseup",Q.removeMouseMoveListener),X.default.operation(X.default.OperationCode.TimeShift,{type:!0,timeShiftDuration:0}),U(Q,w,performance.now())}},M.set(this,function(){return j(Q,n).classList.add(V.default.webPlayerReplayContainer),j(Q,i).classList.add(V.default.webPlayerReplayElement),j(Q,l).classList.add(V.default.webPlayerReplayProgress),j(Q,a).classList.add(V.default.webPlayerReplayCurrentPoint),j(Q,r).classList.add(V.default.webPlayerReplayBar),j(Q,s).classList.add(V.default.webPlayerReplayHighlights,V.default.webPlayerReplayHighlightsHidden),j(Q,l).appendChild(j(Q,a)),j(Q,l).appendChild(j(Q,r)),j(Q,i).appendChild(j(Q,l)),j(Q,i).appendChild(j(Q,s)),j(Q,n).appendChild(j(Q,i)),j(Q,n)}),L.set(this,function(e){var t;if(!e.target.className.includes("highlight")){var i=j(Q,P).call(Q,e);Q.setProgress(i),window.addEventListener("mouseup",Q.removeMouseMoveListener),null===(t=j(Q,o))||void 0===t||t.addEventListener("mousemove",j(Q,E))}}),E.set(this,function(e){var t=j(Q,P).call(Q,e);j(Q,r).style.width=t,j(Q,a).style.left=t}),W.set(this,function(e){U(Q,k,!1),j(Q,n).addEventListener("touchmove",j(Q,S)),j(Q,n).addEventListener("touchend",j(Q,C))}),C.set(this,function(e){j(Q,n).removeEventListener("touchmove",j(Q,S)),j(Q,n).removeEventListener("touchend",j(Q,C)),j(Q,k)&&(U(Q,k,!1),Q.removeMouseMoveListener(e.changedTouches[0]))}),S.set(this,function(e){U(Q,k,!0);var t=j(Q,P).call(Q,e.touches[0]);j(Q,r).style.width=t,j(Q,a).style.left=t}),P.set(this,function(e){var t,n=Number(null!==(t=getComputedStyle(document.documentElement).zoom)&&void 0!==t?t:1),a=e.clientX/n-j(Q,i).getBoundingClientRect().left;a=a<0?0:a;var s=j(Q,i).clientWidth;return(a/s>1?100:a/s*100).toFixed(2)+"%"}),_.set(this,function(t){var i=parseFloat(t.split("%")[0]),n=Date.now()/1e3-j(Q,u);return n=n>j(Q,e)?j(Q,e):n,Math.round(n*(100-i)/100)}),R.set(this,function(t){var i=Date.now()/1e3,n=i-j(Q,u);n=n>j(Q,e)?j(Q,e):n;var a=Math.round(i-t);return{timeShift:a,left:(100-100*a/n).toFixed(2)+"%"}}),I.set(this,function(){var e=document.createElement("div"),t=document.createElement("div"),i=document.createElement("div");return e.classList.add(V.default.backliveBtnContainer),t.classList.add(V.default.backliveBtn),i.classList.add(V.default.backliveDot),t.appendChild(i),t.append("返回直播"),t.onclick=function(){Q.setProgress("100%"),Q.returnLive(),Q.emit("timeShiftChange",0),X.default.operation(X.default.OperationCode.TimeShift,{type:!1,timeShiftDuration:Math.round(performance.now()-j(Q,w))}),U(Q,w,0)},e.appendChild(t),e}),H.set(this,function(e){var t=document.createElement("div");t.classList.add(V.default.highlightItem);var i='<div class="'+V.default.highlightPot+'"></div>';null!=e.pic&&""!==e.pic&&(i+='\n      <div class="'+V.default.highlightIcon+'">\n        <div class="'+V.default.highlightImg+'" style="background-image: url('+e.pic+')">\n        </div>\n      </div>\n      '),t.innerHTML=i,t.onclick=function(){var t,i=j(Q,R).call(Q,e.timestamp),n=i.timeShift,a=i.left;if(Q.setProgress(a),0===j(Q,v)){var s=Q.ctrl.getCtrlUI();U(Q,g,Boolean(null===(t=s.danmaku)||void 0===t?void 0:t.display))}U(Q,v,n),Q.isReplay=0!==n,Q.reload(n),X.default.operation(X.default.OperationCode.TimeShift,{type:!0,isHighlight:!0,timeShiftDuration:0}),U(Q,w,performance.now())},j(Q,c).set(t,O(O({},e),{isAppend:!1,left:""}))}),D.set(this,function(){j(Q,c).forEach(function(e,t){var i=j(Q,R).call(Q,e.timestamp);i.left.includes("-")?(t.remove(),j(Q,c).delete(t)):(t.style.left=i.left,j(Q,c).set(t,O(O({},e),i)),e.isAppend||(j(Q,c).set(t,O(O({},e),{isAppend:!0})),j(Q,s).appendChild(t)))})}),x.set(this,function(e){var t=e.origin.split("://");if(t.length>=2&&/^(?:uat-)?mlive\.bilibili\.co(?::\d+)?$/.test(t[1].split("/")[0])||"production".includes("dev")){var i=e.data;"previewPlaybackTimelineAnchor"===i.type&&Q.handleHighlight({tag_id:0,timestamp:i.data.time,pic:i.data.iconUrl,type:"ADD"})}}),T.set(this,function(){return N(Q,void 0,Promise,function(){var e,t=this;return q(this,function(i){switch(i.label){case 0:return j(this,c).forEach(function(e,i){j(t,c).delete(i),i.remove()}),[4,G.ajax("/xlive/web-room/v1/index/getProgressBarInfo?roomid="+j(this,h)+"&platform=web")];case 1:return e=i.sent(),j(this,b)?[2,!1]:(null!=e.play_tag_list&&"ENABLE"===e.bar_status&&e.play_tag_list.forEach(function(e){t.handleHighlight(O(O({},e),{type:"ADD"}))}),[2,"ENABLE"===e.bar_status])}})})}),A.set(this,function(e){return e.on("message",function(e){switch(e.cmd){case Y.SocketMsgType.PLAY_TAG:Q.handleHighlight(e.data);break;case Y.SocketMsgType.PLAY_PROGRESS_BAR:var t=e.data,i=t.platform,n=t.type;if(!i.includes("web"))return;if(["DISABLE","LIMIT"].includes(n)){if(Q.isReplay){var a=Q.on("timeShiftChange",function(e){0===e&&(Q.removeReplay(),a())});return void j(Q,p).push(a)}Q.removeReplay()}else if(null!=j(Q,h)){var s=Number(e.data.scatter.min),l=Number(e.data.scatter.max),r=setTimeout(function(){Q.init()},Math.floor(1e3*(Math.random()*(l-s)+s)));j(Q,p).push(function(){clearTimeout(r)})}}})}),this.destroy=function(){U(Q,b,!0),Q.removeReplay()},this.returnLive=function(){j(Q,f).forEach(function(e){return e()}),U(Q,f,[]),Q.setProgress("100%"),Q.emit("backLive");var e=Q.ctrl.getCtrlUI();e.ctrlItemVisibility=O(O({},e.ctrlItemVisibility),j(Q,m)),e.onChange("danmaku",{display:j(Q,g)}),Q.isReplay=!1,U(Q,v,0)},this.reload=function(e){if(void 0===e&&(e=j(Q,v)),j(Q,f).forEach(function(e){return e()}),U(Q,f,[]),0!==e){var t=Q.ctrl.getCtrlUI();t.onChange("danmaku",{display:!1}),0===Object.keys(j(Q,m)).length&&U(Q,m,O({},t.ctrlItemVisibility)),t.ctrlItemVisibility=O(O({},t.ctrlItemVisibility),{rightSetting:!1,quality:!1,danmaku:!1}),j(Q,f).push(t.appendCtrlItem(j(Q,d),{xIndex:0})),Q.isReplay=!0}else Q.returnLive();Q.emit("timeShiftChange",e)},B.set(this,function(){var e=Q.ctrl.getCtrlUI();j(Q,n).style.visibility="hidden",j(Q,p).push(Q.ctrl.onChange(function(e,t){"show"===e&&(!1===t&&0===j(Q,v)?j(Q,n).style.visibility="hidden":j(Q,n).style.visibility="visible")}),Q.on("timeShiftChange",function(t){0!==t||e.show?j(Q,n).style.visibility="visible":j(Q,n).style.visibility="hidden"}))}),U(this,o,F),U(this,u,$.live_time),U(this,h,$.rid),j(this,c).clear(),U(this,d,j(this,I).call(this)),j(this,p).push(j(this,A).call(this,J))}}();exports.default=$,e=new WeakMap,t=new WeakMap,i=new WeakMap,n=new WeakMap,a=new WeakMap,s=new WeakMap,l=new WeakMap,r=new WeakMap,o=new WeakMap,c=new WeakMap,u=new WeakMap,d=new WeakMap,h=new WeakMap,p=new WeakMap,f=new WeakMap,v=new WeakMap,m=new WeakMap,y=new WeakMap,w=new WeakMap,g=new WeakMap,b=new WeakMap,k=new WeakMap,M=new WeakMap,L=new WeakMap,E=new WeakMap,W=new WeakMap,C=new WeakMap,S=new WeakMap,P=new WeakMap,_=new WeakMap,R=new WeakMap,I=new WeakMap,H=new WeakMap,D=new WeakMap,x=new WeakMap,T=new WeakMap,A=new WeakMap,B=new WeakMap;
})()