/**
 * id: MWvE
 * path: @bilibili-live/web-player-socket
 */

(function(require,module,exports) {
"use strict";var e,t,n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{l(o.next(e))}catch(t){i(t)}}function a(e){try{l(o.throw(e))}catch(t){i(t)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}l((o=o.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(a){i=[6,a],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},r=this&&this.__classPrivateFieldGet||function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},i=this&&this.__classPrivateFieldSet||function(e,t,n){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,n),n},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SocketMsgType=void 0;var a,l=s(require("../sdk/socket-core.min.js")),u=require("@bilibili-live/web-player-common"),c=s(require("@bilibili-live/web-player-track"));function f(e){return n(this,void 0,Promise,function(){return o(this,function(t){switch(t.label){case 0:return[4,u.ajax("/xlive/web-room/v1/index/getDanmuInfo?id="+e+"&type=0")];case 1:return[2,t.sent()]}})})}!function(e){e.Danmaku="DANMU_MSG",e.SysMsg="SYS_MSG",e.SysGift="SYS_GIFT",e.GuardMsg="GUARD_MSG",e.SendGift="SEND_GIFT",e.Live="LIVE",e.Preparing="PREPARING",e.End="END",e.Close="CLOSE",e.Block="BLOCK",e.Round="ROUND",e.Welcome="WELCOME",e.Refresh="REFRESH",e.ActivityRedPacket="ACTIVITY_RED_PACKET",e.AreaBlock="ROOM_LIMIT",e.PkPre="PK_PRE",e.PkEnd="PK_END",e.PkSettle="PK_SETTLE",e.PkMicEnd="PK_MIC_END",e.HotRoomNotify="HOT_ROOM_NOTIFY",e.PLAY_TAG="PLAY_TAG",e.PLAY_PROGRESS_BAR="PLAY_PROGRESS_BAR",e.LOG_IN_NOTICE="LOG_IN_NOTICE",e.PlayerLogRecycle="LIVE_PLAYER_LOG_RECYCLE"}(a=exports.SocketMsgType||(exports.SocketMsgType={}));var d=function(){function s(n){this.opts=n,e.set(this,null),t.set(this,new u.EventBus),this.on=r(this,t).on,this.emit=r(this,t).emit,this.init().catch(function(e){u.logger.error(e)})}return s.prototype.init=function(){var t;return n(this,void 0,Promise,function(){var n,s,a=this;return o(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,f(this.opts.roomId)];case 1:return n=o.sent(),[3,3];case 2:return s=o.sent(),u.logger.error("get danmainfo failed "+u.any2Str(s)),n={host_list:[],token:"",max_delay:5e3},[3,3];case 3:return u.logger.info("Socket init, serverInfo: "+JSON.stringify(n)),i(this,e,new l.default({rid:this.opts.roomId,uid:null!==(t=this.opts.userId)&&void 0!==t?t:0,url:"wss://broadcastlv.chat.bilibili.com:443/sub",urlList:n.host_list.map(function(e){return"wss://"+e.host+":"+e.wss_port+"/sub"}),retry:!0,retryMaxCount:n.host_list.length,protover:3,customAuthParam:[{type:"string",key:"platform",value:"web"},{type:"number",key:"type",value:2},{type:"string",key:"key",value:n.token}],onOpen:function(){u.logger.info("WebSocket On Open")},onClose:function(){u.logger.info("WebSocket On Close.")},onError:function(t){var n,o,i,s;u.logger.warn("WebSocket On Error. url: "+(null!==(o=null===(n=r(a,e))||void 0===n?void 0:n.getState().url)&&void 0!==o?o:"")),p({type:1,evt:t.code,url:null!==(s=null===(i=r(a,e))||void 0===i?void 0:i.getState().url)&&void 0!==s?s:""})},onInitialized:function(){u.logger.info("WebSocket Initialized.")},onReceivedMessage:function(e,t){u.wpd.SocketMsg2Console&&console.debug("socket onReceivedMessage: "+t,e),t>1&&h(t),[].concat(e).forEach(function(e){a.emit("message",e)})},onHeartBeatReply:function(e){a.emit("heartbeat",e)},onReceiveAuthRes:function(t){var n;u.logger.warn("token expired, reconnect."),null===(n=r(a,e))||void 0===n||n.destroy(),a.init().catch(function(e){u.logger.error(e)})},onListConnectError:function(){var t,n;u.logger.info("WebSocket On List Connect Error."),p({type:2,url:null!==(n=null===(t=r(a,e))||void 0===t?void 0:t.getState().url)&&void 0!==n?n:""})},fallback:function(){u.logger.info("WebSocket Supporting Error.")},onLogger:function(e){u.logger.error(e)}})),[2]}})})},s.prototype.destroy=function(){var n;null===(n=r(this,e))||void 0===n||n.destroy(),r(this,t).destroy()},s}();function h(e){u.ajax("/xlive/open-interface/v1/dm/message_ack",{method:"POST",data:{terminal:0,sequence:e}}).catch(function(e){u.logger.error(e)})}function p(e){c.default.error(c.default.ErrorCode.SocketConnect,JSON.stringify(e))}exports.default=d,e=new WeakMap,t=new WeakMap;
})()