/**
 * id: ao58
 * path: @bilibili-live/web-player-video
 */

(function(require,module,exports) {
"use strict";var e,t,i,r,n,o,a,s,u,d,l,c,f,h,v=this&&this.__assign||function(){return(v=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},p=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(a,s)}u((r=r.apply(e,t||[])).next())})},m=this&&this.__generator||function(e,t){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},y=this&&this.__classPrivateFieldSet||function(e,t,i){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,i),i},w=this&&this.__classPrivateFieldGet||function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},g=this&&this.__spreadArray||function(e,t){for(var i=0,r=t.length,n=e.length;i<r;i++,n++)e[n]=t[i];return e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkVideoRate=exports.Video=exports.VideoError=exports.VideoStatus=exports.EventType=void 0;var E,P,b=require("@bilibili-live/fmp4.js"),k=require("@bilibili-live/web-player-common"),L=require("./video-utils");!function(e){e.VideoInfo="VideoInfo",e.MetaData="MetaData",e.CorePlayerCreated="CorePlayerCreated",e.Error="Error",e.LoadStart="LoadStart",e.Ended="Ended",e.NetworkResponse="NetworkResponse",e.FirstPacket="FirstPacket",e.FirstFrame="FirstFrame",e.SEIData="SEIData",e.Destroyed="Destroyed",e.WaitStart="WaitStart",e.WaitEnd="WaitEnd",e.WaitReport="WaitReport",e.Play="Play",e.Pause="Pause",e.WASMDecoderDegrade="WASMDecoderDegrade",e.MutePlay="MutePlay",e.NotAutoPlay="NotAutoPlay",e.FirstFrameTimeout="FirstFrameTimeout"}(E=exports.EventType||(exports.EventType={})),function(e){e.Initialize="Initialize",e.Loading="Loading",e.Playing="Playing",e.Pause="Pause",e.Destroyed="Destroyed"}(P=exports.VideoStatus||(exports.VideoStatus={}));var T,M=0,S={droppedFrames:0,decodedFrames:0,videoBufferLength:0,videoNetworkActivity:0,audioNetworkActivity:0,audioBufferLength:0},I={corePlayerType:k.CorePlayerType.NativePlayer,width:0,height:0,mimeType:"",volume:0,fps:0,encoder:"",videoDataRate:0,audioDataRate:0,audioSampleRate:0,audioChannel:"",videoSrc:""};!function(e){e[e.FirstFrameTimeout=92001]="FirstFrameTimeout"}(T=exports.VideoError||(exports.VideoError={}));var D=function(){function D(p,m){var b,D=this;void 0===m&&(m={}),e.set(this,void 0),t.set(this,void 0),i.set(this,null),r.set(this,void 0),n.set(this,void 0),o.set(this,{mediaInfo:v({},I),realtimeInfo:v({},S)}),a.set(this,null),s.set(this,P.Initialize),u.set(this,[]),d.set(this,void 0),l.set(this,void 0),c.set(this,new k.EventBus),this.on=w(this,c).on,this.once=w(this,c).once,this.emit=function(e){for(var t,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];[E.VideoInfo,E.SEIData].includes(e)||w(D,n).debug("video emit: "+e+", handlers count: "+w(D,c).getHandlers(e).size),(t=w(D,c)).emit.apply(t,g([e],i))},f.set(this,function(){if(w(D,t).includes(".mp4"))return function(){};var e=setTimeout(function(){D.emit(E.Error,{type:E.FirstFrameTimeout,code:T.FirstFrameTimeout,errInfo:{url:w(D,t)}})},1e4),i=function(){clearTimeout(e)};return D.once(E.FirstFrame,i),function(){i()}}),h.set(this,function(e){var r,a;w(D,n).info("metadata fired"),w(D,o).mediaInfo=Object.assign({},w(D,o).mediaInfo,{videoSrc:w(D,t),width:e.width,height:e.height,mimeType:null===(r=w(D,i))||void 0===r?void 0:r.mimeType,fps:k.roundNumber(e.fps,0),encoder:null!==(a=e.encoder)&&void 0!==a?a:e.creator,videoDataRate:e.videodatarate,audioDataRate:e.audiodatarate,audioSampleRate:e.audiosamplerate,audioChannel:L.parseAudioChannel(e.audiochannel)}),D.emit(E.VideoInfo,D.getVideoInfo()),D.updateStatisticsInfo()}),y(this,r,M),M+=1,y(this,n,new Proxy(k.logger,{get:function(e,t){return["debug","info","warn","error"].includes(t)?function(i){e[t]("id "+w(D,r)+": "+i)}:e[t]}})),y(this,t,p),y(this,d,m),y(this,e,F(null!==(b=m.wasmDecode)&&void 0!==b&&b)),y(this,l,window.setTimeout(function(){D.load()},1))}return Object.defineProperty(D.prototype,"status",{get:function(){return w(this,s)},set:function(e){w(this,n).info("Video status changed to "+e),y(this,s,e)},enumerable:!1,configurable:!0}),D.prototype.delyLoad=function(){clearTimeout(w(this,l))},D.prototype.load=function(){var i;this.status!==P.Destroyed&&(w(this,n).info("load src: "+w(this,t)+", opts: "+JSON.stringify(w(this,d))),this.status=P.Loading,this.createCorePlayer(w(this,e),null===(i=w(this,d))||void 0===i?void 0:i.startTime),this.play().catch(function(e){k.logger.error(e)}))},D.prototype.play=function(){return p(this,void 0,Promise,function(){return m(this,function(t){switch(t.label){case 0:if(w(this,n).info("video play"),null==w(this,e))return[2];if(this.status===P.Playing)return[2];t.label=1;case 1:return t.trys.push([1,3,,8]),[4,w(this,e).play()];case 2:return t.sent(),this.status=P.Playing,[3,8];case 3:if("NotAllowedError"!==t.sent().name)return[2];w(this,n).warn("try mute play"),w(this,e).muted=!0,t.label=4;case 4:return t.trys.push([4,6,,7]),[4,w(this,e).play()];case 5:return t.sent(),this.status=P.Playing,this.emit(E.MutePlay),[3,7];case 6:return t.sent(),w(this,n).warn("can't auto play"),this.status=P.Pause,this.emit(E.NotAutoPlay),[3,7];case 7:return[3,8];case 8:return[2]}})})},D.prototype.pause=function(){w(this,n).info("video pause"),null!=w(this,e)&&this.status===P.Playing&&(w(this,e).pause(),this.status=P.Pause)},D.prototype.seek=function(t){var i=t.forward,r=t.keepBuffer;if(w(this,n).info("video seek, forward: "+(null!=i?i:"null")+", keepBuffer: "+(null!=r?r:"null")),null!=w(this,e)){var o=k.remainBufferLength(w(this,e));if(!(o<=0))if(null!=r&&r>0){if(o<r)return;w(this,e).currentTime+=o-r}else if(null!=i&&i>0){if(i>o)return;w(this,e).currentTime+=i}}},D.prototype.getSrc=function(){return w(this,t)},D.prototype.volume=function(t){w(this,n).info("video setVolume("+t+")"),null!=w(this,e)&&(w(this,e).volume=k.roundNumber(t,2))},D.prototype.mute=function(t){null!=w(this,e)&&(w(this,e).muted=t)},D.prototype.getVideoEl=function(){return w(this,e)},D.prototype.removeVideoEl=function(){var t,i;w(this,e).remove(),null===(i=(t=w(this,e)).destroy)||void 0===i||i.call(t)},D.prototype.getVideoInfo=function(){return w(this,o).mediaInfo.volume=w(this,e).volume,w(this,o)},D.prototype.capturePic=function(t,i){var r,n,o=null===(n=(r=w(this,e)).toDataURL)||void 0===n?void 0:n.call(r,t,i);return null!=o?o:C(w(this,e),t,i)},D.prototype.switchAudioTrack=function(t){var r,n;return w(this,i)instanceof b.Hls7Player?null==(null===(r=w(this,i))||void 0===r?void 0:r.switchAudioTrack)?-1:(null===(n=w(this,i))||void 0===n||n.switchAudioTrack(t),k.remainBufferLength(w(this,e))):-1},D.prototype.getAudioTracks=function(){var e,t,r;return w(this,i)instanceof b.Hls7Player&&null!==(r=null===(t=null===(e=w(this,i))||void 0===e?void 0:e.getAudioTracks)||void 0===t?void 0:t.call(e))&&void 0!==r?r:[]},D.prototype.destroy=function(t){var r,s;if(void 0===t&&(t=!1),t||this.removeVideoEl(),this.status!==P.Destroyed){this.status=P.Destroyed,w(this,n).info("video destroyed, holdLastFrame: "+t.toString()),clearTimeout(w(this,l)),clearInterval(null!==(r=w(this,a))&&void 0!==r?r:0),y(this,o,{mediaInfo:v({},I),realtimeInfo:v({},S)}),w(this,e).pause(),w(this,u).forEach(function(e){return null==e?void 0:e()});try{null===(s=w(this,i))||void 0===s||s.destroy()}catch(d){k.logger.error("corePlayer destroy error!!")}this.emit(E.Destroyed),w(this,c).destroy()}},D.prototype.createCorePlayer=function(e,r){var n=this;if(null!=w(this,t)){var a,s,l=!0===w(this,d).wasmDecode?new window.BwpMediaSource:null!=window.MediaSource?new window.MediaSource:{},c=new URL(w(this,t)).pathname;if(c.endsWith(".flv"))a=new b.fMp4Player(l,e),s=k.CorePlayerType.fMp4Player;else if(c.endsWith(".m3u8"))!0===w(this,d).forceNativePlayer||null==window.MediaSource?(a=new b.NativePlayer(l,e),s=k.CorePlayerType.NativePlayer):(a=new b.Hls7Player(l,e),s=k.CorePlayerType.Hls7Player);else{if(!c.endsWith(".mp4"))throw new Error("Unsupported stream url: "+c);a=new b.NativePlayer(l,e),s=k.CorePlayerType.NativePlayer}w(this,o).mediaInfo=Object.assign({},w(this,o).mediaInfo,{corePlayerType:s}),this.emit(E.LoadStart,{corePlayer:a,videoEl:e,src:w(this,t)}),a.keepUsedBuffer=10,a.timeout=7e3,w(this,u).push(this.bindEvents(a,e),w(this,f).call(this)),null!=r&&r>0&&(a instanceof b.fMp4Player||a instanceof b.NativePlayer)&&(a.startTime=r),s===k.CorePlayerType.NativePlayer&&c.endsWith(".m3u8")?L.redirectHLSV3(w(this,t)).then(function(e){a.src=e}).catch(function(e){a.src=w(n,t),k.logger.error(e)}):a.src=w(this,t),y(this,i,a),this.emit(E.CorePlayerCreated,{corePlayer:a,videoEl:e,src:w(this,t)})}},D.prototype.updateStatisticsInfo=function(){var t=this,r=0;null!=w(this,a)&&clearInterval(w(this,a)),y(this,a,window.setInterval(function(){var n,a,s,u=null!==(s=null===(a=null===(n=w(t,e))||void 0===n?void 0:n.getVideoPlaybackQuality)||void 0===a?void 0:a.call(n))&&void 0!==s?s:{},d=u.droppedVideoFrames,l=void 0===d?0:d,c=u.totalVideoFrames,f=void 0===c?0:c,h=0;null!=w(t,i)&&(h=w(t,i).receivedBytes-r,Number.isNaN(h)&&(h=0),r=w(t,i).receivedBytes),w(t,o).realtimeInfo=Object.assign({},w(t,o).realtimeInfo,{droppedFrames:l,decodedFrames:f,videoBufferLength:null==w(t,e)?0:k.roundNumber(k.remainBufferLength(w(t,e)),3),videoNetworkActivity:h}),t.emit(E.VideoInfo,t.getVideoInfo())},1e3))},D.prototype.bindEvents=function(e,t){var i=this,a=performance.now(),s=!1;e.onMetaData=function(e){w(i,h).call(i,e),i.emit(E.MetaData,performance.now()-a),w(i,n).info("after onMetaData mediaInfo: "+JSON.stringify(w(i,o).mediaInfo))},e.onSeiData=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.emit.apply(i,g([E.SEIData],e))},e.onFileFetched=function(e,t){var r=t.used,o=t.duration,a=2e3;0===o?a=2e3:o<=500&&(a=500),r>a&&w(i,n).warn("fetch slowly: "+e+", cost "+r+"ms, duration: "+o+"ms")},e.onFirstResponse=function(e){i.emit(E.NetworkResponse,e)},e.onEndOfStream=function(){var e=Math.ceil(k.remainBufferLength(t));(e<0||isNaN(e))&&(e=0),w(i,n).warn("video onEndOfStream, bufLen: "+e),setTimeout(function(){t.dispatchEvent(new Event("ended"))},1e3*e)},e.onFirstPacket=function(){var e=performance.now()-a;w(i,n).info("video first packet cost: "+Math.round(e)),i.emit(E.FirstPacket,performance.now()-a)};var u=function(e,t,r){if(!s){s=!0;var o=k.any2Str({code:t,errInfo:r});w(i,n).error("player core "+e+", "+o),i.emit(E.Error,{code:t,errInfo:r}),i.destroy()}};e.onNetworkError=u.bind(this,"NetworkError"),e.onParserError=u.bind(this,"ParserError");var l=function(){var e=performance.now()-a;w(i,n).info("video first frame cost: "+Math.round(e)),i.emit(E.FirstFrame,e)};t.addEventListener("loadeddata",l);var c=function(){s||(s=!0,i.emit(E.Ended),i.destroy())};t.addEventListener("ended",c);var f=function(){if(!s){s=!0;var e=t.error,r={code:90002,errInfo:{code:null==e?void 0:e.code,msg:null==e?void 0:e.message}};w(i,n).error("video native error: "+k.any2Str(r)),i.emit(E.Error,r),i.destroy()}};t.addEventListener("error",f);var v=W(t,e,{startCb:function(){w(i,n).warn("video waiting!, bufferLen: "+k.remainBufferLength(t)),i.emit(E.WaitStart)},endCb:function(){w(i,n).info("video playing"),i.emit(E.WaitEnd)},reportCb:function(e){i.emit(E.WaitReport,e)},id:w(this,r)}),p=function(){i.emit(E.Play)};t.addEventListener("play",p);var m=function(){i.emit(E.Pause)};t.addEventListener("pause",m);var y=function(){};!0===w(this,d).wasmDecode&&(y=function(){i.emit(E.WASMDecoderDegrade)},t.addEventListener("performance",y));var P=k.mediaAction.on("pause",function(){t.pause()}),b=k.mediaAction.on("play",function(){t.play().catch(function(e){k.logger.error(e)})});return function(){t.removeEventListener("loadeddata",l),t.removeEventListener("ended",c),t.removeEventListener("error",f),t.removeEventListener("play",p),t.removeEventListener("pause",m),t.removeEventListener("performance",y),v(),P(),b()}},D}();function F(e){var t=document.createElement(e?"bwp-video":"video");return t.id="video-"+Math.random().toString().slice(2),t.style.cssText="\n    position: absolute;\n    top: 0;\n    left: 0;\n    z-index: 1;\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n  ",t.volume=.9,t.autoplay=!0,t.setAttribute("webkit-playsinline","true"),t.setAttribute("playsinline","true"),t}function W(e,t,i){var r=i.startCb,n=i.endCb,o=i.reportCb,a=i.id,s=!1,u=function t(){s=!0,e.removeEventListener("loadeddata",t)};e.addEventListener("loadeddata",u);var d=!1,l=function t(){e.removeEventListener("progress",t),d&&(d=!1,n())},c=function(){s&&(d=!0,r(),e.addEventListener("progress",l))},f=function(){e.removeEventListener("progress",l),d&&(d=!1,n())};e.addEventListener("waiting",c),e.addEventListener("playing",f);var h=new b.BufferDetector(e,1e3),v=0,p=0,m=0,y=0,w=performance.now(),g=function(){var i=performance.now(),r=t.receivedBytes-y;y=t.receivedBytes,o({count:h.waitedCount-v,duration:Math.round(h.waitedDuration-p),windowSize:Math.round(i-w),playTime:Math.round(e.currentTime-m),playedTime:Math.round(e.currentTime),receivedBytes:r,id:a}),v=h.waitedCount,p=h.waitedDuration,m=e.currentTime,w=i},E=window.setInterval(g,6e4),P=function(){g()};return window.addEventListener("beforeunload",P),function(){clearInterval(E),g(),window.removeEventListener("beforeunload",P),e.removeEventListener("playing",f),e.removeEventListener("waiting",c),e.removeEventListener("loadeddata",u),h.destroy()}}function N(e){if(e.videoHeight>e.videoWidth){var t=V(e);return e.insertAdjacentElement("afterend",t),t}return null}function V(e){var t=C(e),i=null;return(i=document.createElement("div")).style.cssText="\n    background-image: url("+t+");\n    background-size: cover;\n    background-position: center;\n    width: 100%;\n    height: 100%;\n    filter: blur(35px);\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n  ",i}function C(e,t,i){var r;void 0===t&&(t="image/jpeg"),void 0===i&&(i=.8);var n=document.createElement("canvas");return n.width=e.videoWidth,n.height=e.videoHeight,null===(r=n.getContext("2d"))||void 0===r||r.drawImage(e,0,0,n.width,n.height),n.toDataURL(t,i)}exports.Video=D,e=new WeakMap,t=new WeakMap,i=new WeakMap,r=new WeakMap,n=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap,u=new WeakMap,d=new WeakMap,l=new WeakMap,c=new WeakMap,f=new WeakMap,h=new WeakMap,exports.checkVideoRate=N;
})()