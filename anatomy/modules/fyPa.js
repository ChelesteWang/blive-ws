/**
 * id: fyPa
 * path: ./sticker
 */

(function(require,module,exports) {
"use strict";var t,e,i,r,n,s,o,h,a,l,c,d,p,g,f,u,w,_,m,b,k,v,y=this&&this.__assign||function(){return(y=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},x=this&&this.__awaiter||function(t,e,i,r){return new(i||(i=Promise))(function(n,s){function o(t){try{a(r.next(t))}catch(e){s(e)}}function h(t){try{a(r.throw(t))}catch(e){s(e)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,h)}a((r=r.apply(t,e||[])).next())})},T=this&&this.__generator||function(t,e){var i,r,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function h(s){return function(h){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,r&&(n=2&s[0]?r.return:s[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,s[1])).done)return n;switch(r=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(h){s=[6,h],r=0}finally{i=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,h])}}},M=this&&this.__classPrivateFieldSet||function(t,e,i){if(!e.has(t))throw new TypeError("attempted to set private field on non-instance");return e.set(t,i),i},E=this&&this.__classPrivateFieldGet||function(t,e){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)};Object.defineProperty(exports,"__esModule",{value:!0});var W,R=require("@bilibili-live/web-player-common");!function(t){t[t.Normal=1]="Normal",t[t.Text=2]="Text"}(W||(W={}));var B=R.isWebPSupported(),S=function(){return function(S){var I=this;this.container=S,t.set(this,void 0),e.set(this,void 0),i.set(this,null),r.set(this,0),n.set(this,0),s.set(this,new Map),o.set(this,new Map),h.set(this,[]),a.set(this,0),l.set(this,[]),c.set(this,!1),this.onSei=function(t){E(I,w).call(I,t).catch(function(t){throw R.logger.error("贴纸加载失败"),new Error(t)})},this.onVideoInfo=function(i){i.width!==E(I,t).width&&i.height!==E(I,t).height&&(M(I,t,i),M(I,e,{width:0,height:0}))},d.set(this,function(t){var e,i;E(I,s).has(t.sticker_id)||E(I,c)||(M(I,c,!0),t.sticker_type===W.Text?(null===(e=E(I,s).get(t.sticker_id))||void 0===e||e.el.remove(),E(I,s).set(t.sticker_id,E(I,p).call(I,t))):(null===(i=E(I,s).get(t.sticker_id))||void 0===i||i.el.remove(),E(I,s).set(t.sticker_id,E(I,g).call(I,t))))}),p.set(this,function(t){R.logger.info("create text sticker, id: "+t.sticker_id);var i=new Image,s=document.createElement("div"),h=E(I,o).get(t.sticker_id);return i.onload=function(){I.container.append(i),h.stretch.top_margin=(i.height-3)/2,h.stretch.bottom_margin=i.height/2,E(I,o).set(t.sticker_id,y(y({},h),{width:i.width,height:i.height}));var a=E(I,f).call(I,h,i.getBoundingClientRect(),t),l=document.createElement("span");l.innerText=t.sticker_title,l.style.cssText="\n        color: "+t.sticker_title_color+";\n        font-size: "+(a.borderBottom+a.borderTop)+"px;\n        position: absolute;\n        z-index: 4;\n        visibility: hidden;\n        word-break: keep-all;\n        white-space: no-wrap;\n        transform: scale(0.3);\n        transform-origin: 0 0;\n        white-space: nowrap;\n        cursor: default;\n        user-select: none;\n      ",I.container.append(l),l.style.cssText+="\n        top: -"+2.2*h.title.bottom_margin/i.height*(a.borderBottom+a.borderTop)+"px;\n        left: -"+(3*h.title.right_margin/i.width*a.width-.3*a.height)+"px;\n      ",s.style.cssText="\n        transition: all .1s ease-in-out;\n        position: absolute;\n        z-index: 4;\n        border-style: solid;\n        border-color: transparent;\n        border-left-width: "+a.borderLeft+"px;\n        border-right-width: "+a.borderRight+"px;\n        border-top-width: "+a.borderTop+"px;\n        border-bottom-width: "+a.borderBottom+"px;\n        width: "+(l.getBoundingClientRect().width-a.borderRight+.5*a.height)+"px;\n        border-image-source: url("+h.url+");\n        border-image-repeat: stretch stretch;\n        border-image-slice: "+h.stretch.top_margin+" "+h.stretch.right_margin+" "+h.stretch.bottom_margin+" "+h.stretch.left_margin+" fill;\n      ",s.append(l),I.container.append(s);var d=E(I,e).width,p=E(I,e).height;d-=s.getBoundingClientRect().width,p=p-a.borderBottom-a.borderTop-l.getBoundingClientRect().height,t.display_width-t.sticker_right_offset<2?s.style.cssText+="\n            left: "+(E(I,n)+d)+"px;\n            top: "+(E(I,r)+Math.min(t.sticker_top_offset*E(I,e).height/t.display_height,p))+"px;\n          ":s.style.cssText+="\n            left: "+(E(I,n)+Math.min(t.sticker_left_offset*E(I,e).width/t.display_width,d))+"px;\n            top: "+(E(I,r)+Math.min(t.sticker_top_offset*E(I,e).height/t.display_height,p))+"px;\n          ",l.style.visibility="visible",i.remove(),M(I,c,!1)},i.src=B?h.url:h.url.replace(".webp",".gif"),i.style.visibility="hidden",{el:s,sei:t,width:0,height:0}}),g.set(this,function(t){R.logger.info("create img sticker, id: "+t.sticker_id);var i=new Image,s=E(I,o).get(t.sticker_id);return I.container.append(i),i.onload=function(){var h=E(I,e).width,a=E(I,e).height,l=E(I,f).call(I,s,i.getBoundingClientRect(),t);a-=l.height,h-=l.width,i.style.cssText="\n          transition: all .1s ease-in-out;\n          position: absolute;\n          z-index: 4;\n        ",t.display_width-t.sticker_right_offset<2?i.style.cssText+="\n            left: "+(E(I,n)+h)+"px;\n            top: "+(E(I,r)+Math.min(t.sticker_top_offset*E(I,e).height/t.display_height,a))+"px;\n          ":i.style.cssText+="\n            left: "+(E(I,n)+Math.min(t.sticker_left_offset*E(I,e).width/t.display_width,h))+"px;\n            top: "+(E(I,r)+Math.min(t.sticker_top_offset*E(I,e).height/t.display_height,a))+"px;\n          ",E(I,o).set(t.sticker_id,y(y({},s),{width:i.width,height:i.height})),i.width=l.width,M(I,c,!1)},i.src=B?s.url:s.url.replace(".webp",".gif"),{el:i,sei:t,width:0,height:0}}),this.batchUpdateStickerElement=function(){E(I,s).forEach(function(t,e){E(I,u).call(I,e)})},f.set(this,function(t,i,r){var n={width:0,height:0,top:0,left:0,borderLeft:0,borderRight:0,borderTop:0,borderBottom:0};if(n.height=E(I,e).height*(r.sticker_bottom_offset-r.sticker_top_offset)/r.display_height/1.1,n.width=n.height*i.width/i.height,t.sticker_type===W.Text){var s=t,o=s.stretch,h=o.top_margin,a=o.left_margin,l=o.right_margin,c=o.bottom_margin,d=s.title,p=d.top_margin,g=d.left_margin;n.borderBottom=n.height/(c+h)*c,n.borderLeft=n.width/(a+l)*a,n.borderRight=n.width/(a+l)*l,n.borderTop=n.height/(c+h)*h,n.left=g*n.width/i.width,n.top=p*n.width/i.width}return n}),u.set(this,function(t){var i=E(I,s).get(t),h=E(I,o).get(t);if(null!=i&&null!=h){var a=E(I,f).call(I,h,{width:h.width,height:h.height},i.sei),l=E(I,e).width,c=E(I,e).height;if(i.sei.sticker_type===W.Text){var d=h,p=i.el,g=p.firstElementChild;if(null==g)return void E(I,v).call(I);var u=a.borderBottom+a.borderTop;g.style.fontSize=u.toString()+"px",g.innerText=String(i.sei.sticker_title);var w=g.getBoundingClientRect().width-a.borderRight+.5*a.height;w=w>0?w:0,p.style.cssText+="\n          border-left-width: "+a.borderLeft+"px;\n          border-right-width: "+a.borderRight+"px;\n          border-top-width: "+a.borderTop+"px;\n          border-bottom-width: "+a.borderBottom+"px;\n          width: "+w+"px;\n        ",g.style.cssText+="\n          top: -"+2.2*d.title.bottom_margin/d.height*(a.borderBottom+a.borderTop)+"px;\n          color: "+i.sei.sticker_title_color+";\n          left: -"+(3*d.title.right_margin/h.width*a.width-.3*a.height)+"px;\n        ",l=l-a.borderLeft-a.borderRight-w,c=c-a.borderBottom-a.borderTop-g.getBoundingClientRect().height}else i.el.width=a.width,c-=a.height,l-=a.width;i.el.style.cssText+="\n        display: block;\n      ",i.sei.display_width-i.sei.sticker_right_offset<2?i.el.style.cssText+="\n          left: "+(E(I,n)+l)+"px;\n          top: "+(E(I,r)+Math.min(i.sei.sticker_top_offset*E(I,e).height/i.sei.display_height,c))+"px;\n        ":i.el.style.cssText+="\n          left: "+(E(I,n)+Math.min(i.sei.sticker_left_offset*E(I,e).width/i.sei.display_width,l))+"px;\n          top: "+(E(I,r)+Math.min(i.sei.sticker_top_offset*E(I,e).height/i.sei.display_height,c))+"px;\n        "}}),w.set(this,function(i){return x(I,void 0,Promise,function(){var r,n,h,c,p,g=this;return T(this,function(f){if(0===E(this,t).width)return[2];if(!i.includes("LIVE_STICKER"))return[2];if(r=JSON.parse(i),0===E(this,e).width&&(E(this,m).call(this,r.LIVE_STICKER[0]),this.batchUpdateStickerElement()),clearTimeout(E(this,a)),0===r.LIVE_STICKER.length)return E(this,v).call(this),[2];for(E(this,s).forEach(function(t,e){for(var i,n=!0,o=0,h=r.LIVE_STICKER;o<h.length;o++)h[o].sticker_id===e&&(n=!1);n&&(null===(i=t.el)||void 0===i||i.remove(),R.logger.info("remove sticker id: "+t.sei.sticker_id),E(g,s).delete(e))}),n=0,h=r.LIVE_STICKER;n<h.length;n++)if(c=h[n],E(this,s).has(c.sticker_id))(null==(p=E(this,s).get(c.sticker_id))?void 0:p.sei.hash)!==c.hash&&(null!=p?(E(this,s).set(c.sticker_id,y(y({},p),{sei:c})),E(this,u).call(this,c.sticker_id)):(R.logger.info("2remove sticker id: "+c.sticker_id),E(this,s).delete(c.sticker_id)));else if(E(this,o).has(c.sticker_id))E(this,d).call(this,c);else{if(E(this,l).includes(c.group_id))return[2];E(this,l).push(c.group_id),E(this,k).call(this,c.group_id,c).catch(function(t){R.logger.error(t)})}return[2]})})}),_.set(this,function(){window.addEventListener("resize",E(I,b)),document.addEventListener("fullscreenchange",E(I,b)),E(I,h).push(function(){window.removeEventListener("resize",E(I,b)),document.removeEventListener("fullscreenchange",E(I,b))})}),this.calcDisplayInfo=function(){if(null!=E(I,i)){var s=I.container.getBoundingClientRect().height,o=I.container.getBoundingClientRect().width,h=E(I,t).width,a=E(I,t).height;s/a<o/h?(M(I,e,{width:s*h/a,height:s*h/a*E(I,i).display_height/E(I,i).display_width}),M(I,r,E(I,e).width*E(I,i).display_height/E(I,i).display_width*.2),M(I,n,(o-E(I,e).width)/2)):(M(I,n,0),M(I,e,{width:o,height:o*E(I,i).display_height/E(I,i).display_width}),M(I,r,(s-E(I,e).width/7*4)/2+E(I,e).width/14))}},m.set(this,function(t){M(I,i,t),null!=t&&I.calcDisplayInfo()}),this.destroy=function(){E(I,v).call(I),M(I,c,!1),E(I,h).forEach(function(t){return t()}),M(I,h,[]),M(I,t,{width:0,height:0}),M(I,e,{width:0,height:0}),M(I,l,[])},b.set(this,function(){I.calcDisplayInfo(),I.batchUpdateStickerElement()}),k.set(this,function(t,e){return x(I,void 0,Promise,function(){var i=this;return T(this,function(r){return R.ajax.disperse("/xlive/web-room/v1/stickers/getStickers",{scope:1e3*e.request_random_sec_range,expiresTime:performance.now()+1e3*e.request_random_sec_range}),R.ajax("/xlive/web-room/v1/stickers/getStickers?id="+t).then(function(t){for(var r=0,n=t.pic_stickers;r<n.length;r++){var s=n[r];E(i,o).has(s.id)||E(i,o).set(s.id,s)}for(var h=0,a=t.text_stickers;h<a.length;h++){var l=a[h];E(i,o).has(l.id)||(l.stretch.top_margin*=3,l.stretch.left_margin*=3,l.stretch.right_margin*=3,l.stretch.bottom_margin*=3,E(i,o).set(l.id,l))}E(i,d).call(i,e)}).catch(function(t){R.logger.error(t)}),[2]})})}),v.set(this,function(){E(I,s).forEach(function(t){var e=t.el;null==e||e.remove()}),E(I,s).clear()}),M(this,t,{width:0,height:0}),M(this,e,{width:0,height:0}),E(this,_).call(this)}}();exports.default=S,t=new WeakMap,e=new WeakMap,i=new WeakMap,r=new WeakMap,n=new WeakMap,s=new WeakMap,o=new WeakMap,h=new WeakMap,a=new WeakMap,l=new WeakMap,c=new WeakMap,d=new WeakMap,p=new WeakMap,g=new WeakMap,f=new WeakMap,u=new WeakMap,w=new WeakMap,_=new WeakMap,m=new WeakMap,b=new WeakMap,k=new WeakMap,v=new WeakMap;
})()