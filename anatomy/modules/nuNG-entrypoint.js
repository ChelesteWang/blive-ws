/**
 * id: nuNG
 */

(function(require,module,exports) {
"use strict";var e=this&&this.__assign||function(){return(e=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},t=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&t(i,e,a);return n(i,e),i},a=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(a,o){function r(e){try{u(i.next(e))}catch(t){o(t)}}function l(e){try{u(i.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,l)}u((i=i.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var n,i,a,o,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(a=2&o[0]?i.return:o[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,o[1])).done)return a;switch(i=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return r.label++,{value:o[1],done:!1};case 5:r.label++,i=o[1],o=[0];continue;case 7:o=r.ops.pop(),r.trys.pop();continue;default:if(!(a=(a=r.trys).length>0&&a[a.length-1])&&(6===o[0]||2===o[0])){r=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){r.label=o[1];break}if(6===o[0]&&r.label<a[1]){r.label=a[1],a=o;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(o);break}a[2]&&r.ops.pop(),r.trys.pop();continue}o=t.call(e,r)}catch(l){o=[6,l],i=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},r=this&&this.__classPrivateFieldGet||function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},l=this&&this.__classPrivateFieldSet||function(e,t,n){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,n),n},u=this&&this.__spreadArray||function(e,t){for(var n=0,i=t.length,a=e.length;n<i;n++,a++)e[a]=t[n];return e},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RoomPlayer=void 0;var c,d=require("@bilibili-live/web-player-common"),v=require("@bilibili-live/web-player"),f=i(require("@bilibili-live/web-player-socket")),p=require("./danmaku-biz"),m=require("./biz-common"),h=require("./biz-interface"),y=i(require("@bilibili-live/web-player-track")),g=require("./ui-components/end-recommend-panel"),E=s(require("./ui-components/video-logo")),k=s(require("./ui-components/feedback")),S=require("./ui-components/error-panel"),w=s(require("./ui-components/preround-conuter")),b=s(require("@bilibili-live/web-player-contextmenu")),T=s(require("@bilibili-live/web-player-video-info")),I=s(require("@bilibili-live/web-player-danmaku-report")),M=s(require("./ui-components/log-panel")),C=s(require("./browser-fullscreen")),x=require("./log-storage"),P=require("./ui-components/not-auto-play"),V=require("./video-enhance");d.logger.printToConsole=d.wpd.Log2Console,m.commonLogInfo("RoomPlayer"),function(e){e[e.Click=1]="Click",e[e.Esc=2]="Esc",e[e.DBClick=3]="DBClick",e[e.Other=4]="Other"}(c||(c={}));var D=function(){function t(t,be){var Te,Ie,Me,Ce,xe,Pe,Ve,De,Re=this;this.container=t,this.opts=be,n.set(this,void 0),i.set(this,void 0),s.set(this,void 0),P.set(this,null),D.set(this,void 0),q.set(this,void 0),H.set(this,void 0),j.set(this,void 0),G.set(this,void 0),Q.set(this,[]),J.set(this,null),K.set(this,null),Y.set(this,!1),X.set(this,new d.EventBus),Z.set(this,{}),$.set(this,[]),ee.set(this,0),te.set(this,!1),ne.set(this,void 0),ie.set(this,void 0),ae.set(this,null),oe.set(this,function(){}),re.set(this,void 0),this.reload=function(){return a(Re,void 0,Promise,function(){var e,t,i,a,u;return o(this,function(o){switch(o.label){case 0:if(r(this,te))return[2];l(this,te,!0),null===(i=r(this,ae))||void 0===i||i.remove(),l(this,ae,null),o.label=1;case 1:return o.trys.push([1,,4,5]),e=r(this,s),null!=(t=r(this,n))?[3,3]:[4,m.initRoomInfoOrBlock({roomId:e,isMobile:!1},this.container,this.opts.roomInfoProvider)];case 2:t=o.sent(),o.label=3;case 3:if(r(this,Y))return[2];switch(r(this,pe).call(this),null===(a=r(this,K))||void 0===a||a.setRoomStatus(t.live_status),t.live_status){case h.RoomStatus.Preparing:r(this,ge).call(this,e),this.updateRoomStatus(h.RoomStatus.Preparing);break;case h.RoomStatus.Live:this.updateRoomStatus(h.RoomStatus.Live),l(this,P,r(this,se).call(this,t,r(this,D)));break;case h.RoomStatus.Round:this.updateRoomStatus(h.RoomStatus.Round),l(this,P,r(this,le).call(this))}return this.emit(d.ExternalEventType.WebPlayerCreated),null!=r(this,P)&&(r(this,ke).call(this),r(this,Q).push(m.pause10SecBlockStream(r(this,P),this)),!1===(null===(u=this.opts.UI)||void 0===u?void 0:u.danmaku)&&m.disableDanmaku({danmakuBiz:r(this,q),ctrl:r(this,P).ctrl})),r(this,Q).push(r(this,de).call(this,r(this,D))),l(this,n,void 0),[3,5];case 4:return l(this,te,!1),d.logger.info("room player is reload"),[7];case 5:return[2]}})})},le.set(this,function(){var e,t,n=r(Re,s),a=new v.RoundPlayer(Re.container,{roomId:n,userId:r(Re,i),enableCtrlUI:null===(t=null===(e=Re.opts.UI)||void 0===e?void 0:e.enableCtrlUI)||void 0===t||t});return y.default.event(y.EventCode.CreateRoundPlayer,{sample:.1}),a.on("failed",function(e,t,i){void 0===i&&(i=y.default.ErrorCode.RoomRoundUnknow),e===v.NonRoundStatus.Preround?r(Re,Q).push(w.default(Re.container,Re.reload,t)):e===v.NonRoundStatus.Nonenabled?r(Re,ge).call(Re,n,"系统维护中,轮播暂时不可用"):(y.default.error(i,""+e),r(Re,Q).push(S.createErrorPanel(Re.container,i)))}),a.on(v.VideoEventType.FirstFrame,function(){var e,t=a.getVideoEl();null!=t&&(r(Re,q).danmakuStateHandler.updateVideoEl(t),!0===(null===(e=Re.opts.UI)||void 0===e?void 0:e.enableMaskDanmaku)&&r(Re,q).danmakuStateHandler.maskSwitch(!0))}),d.EventBus.forwardEvent(a,Re,[d.ExternalEventType.StartPlayRound,d.ExternalEventType.Reload,v.VideoEventType.MutePlay,v.VideoEventType.NotAutoPlay,[v.VideoEventType.WaitEnd,d.ExternalEventType.WaitEnd],[v.VideoEventType.WaitStart,d.ExternalEventType.WaitStart],[v.VideoEventType.FirstFrame,d.ExternalEventType.FirstFrame],[v.VideoEventType.Play,d.ExternalEventType.Playing],[v.VideoEventType.Pause,d.ExternalEventType.Paused]]),r(Re,Q).push(R(r(Re,q),a.ctrl,r(Re,i)),_(a.ctrl,Re)),a}),ue.set(this,function(){C.default.exitFullscreen().then(function(){Re.emit(d.ExternalEventType.FeedBackClick)}).catch(function(e){d.logger.warn(e)})}),se.set(this,function(e,t){var n,l,u,c,f,p=Re.opts,g=p.rnd,E=p.UI,k=new v.LivePlayer(Re.container,{roomId:r(Re,s),roomInfo:e,userId:r(Re,i),rnd:g,enableCtrlUI:null===(n=null==E?void 0:E.enableCtrlUI)||void 0===n||n,roomInfoProvider:function(e){return a(Re,void 0,void 0,function(){return o(this,function(t){switch(t.label){case 0:return[4,m.loadRoomInfo(e,this.opts.roomInfoProvider)];case 1:return[2,t.sent()]}})})}},t);r(Re,$).push(m.dmVisualVibrate(k,r(Re,q))),v.isBwpSupported()&&k.showHEVCQuality(!0);var b=k.ctrl.getCtrlUI();for(var T in!0===(null===(l=Re.opts.UI)||void 0===l?void 0:l.showMirror)&&(b.ctrlItemVisibility.mirror=!0),null!=(null===(u=Re.opts.UI)||void 0===u?void 0:u.pip)&&(b.ctrlItemVisibility.pip=null===(c=Re.opts.UI)||void 0===c?void 0:c.pip),!1===(null===(f=Re.opts.UI)||void 0===f?void 0:f.webFullScreen)&&(b.ctrlItemVisibility.webFullScreen=!1),r(Re,Z))"setAutoSyncCfg"===T&&k.setAutoSyncCfg(r(Re,Z)[T]);return r(Re,ce).refresh(k),k.on(v.LivePlayerEvent.Failed,function(e,t){y.default.error(e,null!=t?t:""),r(Re,Q).push(S.createErrorPanel(Re.container,e,t)),k.destroy()}),k.on(v.LivePlayerEvent.LiveStatusChange,function(e){Re.updateRoomStatus(h.RoomStatus.Preparing),r(Re,Se).call(Re),e===h.RoomStatus.Round?r(Re,Q).push(w.default(Re.container,Re.reload)):r(Re,ge).call(Re,r(Re,s))}),k.on(v.VideoEventType.FirstFrame,function(){var e,t=k.getVideoEl();if(null!=t){r(Re,q).danmakuStateHandler.updateVideoEl(t);var n=!0===(null===(e=Re.opts.UI)||void 0===e?void 0:e.enableMaskDanmaku);r(Re,q).danmakuStateHandler.maskSwitch(n),N({dmBiz:r(Re,q),dmSwitch:k.ctrl.getCtrlUI().danmaku.display})}}),d.EventBus.forwardEvent(k,Re,[d.ExternalEventType.SwitchLine,d.ExternalEventType.SwitchQuality,d.ExternalEventType.SwitchQualityNotLogin,d.ExternalEventType.Reload,d.ExternalEventType.SEIParseData,[v.VideoEventType.WaitEnd,d.ExternalEventType.WaitEnd],[v.VideoEventType.WaitStart,d.ExternalEventType.WaitStart],v.VideoEventType.MutePlay,v.VideoEventType.NotAutoPlay,[v.VideoEventType.FirstFrame,d.ExternalEventType.FirstFrame],[v.VideoEventType.Play,d.ExternalEventType.Playing],[v.VideoEventType.Pause,d.ExternalEventType.Paused],[v.VideoEventType.MetaData,d.ExternalEventType.MetaDataChange],[v.LivePlayerEvent.VideoError,d.ExternalEventType.VideoError],[v.LivePlayerEvent.Failed,d.ExternalEventType.PlayFaild]]),r(Re,Q).push(R(r(Re,q),k.ctrl,r(Re,i)),_(k.ctrl,Re),F(r(Re,H),k)),k}),ce.set(this,(Ce=!1,xe=function(){},{start:Pe=function(e){Ce=!0,xe(),e instanceof v.LivePlayer&&(xe=V.startVideoCAS(e)),y.default.custom(y.default.CustomCode.VideoEnhance,1,{extFields:["videoTag","quality","sCodec"]})},stop:function(){Ce=!1,xe(),y.default.custom(y.default.CustomCode.VideoEnhance,0,{extFields:["videoTag","quality","sCodec"]})},refresh:function(e){Ce&&Pe(e)}})),de.set(this,function(e){d.logger.info("room player listen socket message");var t=function(e){d.logger.warn("refresh by socket "+e),Re.reload().catch(function(e){d.logger.error(e)})},n=r(Re,s),a=e.on("message",function(e){if(!e.cmd.startsWith("DANMU_MSG")){switch(e.cmd){case f.SocketMsgType.Live:if(r(Re,P)instanceof v.LivePlayer)break;r(Re,Q).push(d.disperseAction(1e4,function(){t(e.cmd)}));break;case f.SocketMsgType.Round:if(r(Re,P)instanceof v.RoundPlayer)break;t(e.cmd);break;case f.SocketMsgType.Preparing:r(Re,Se).call(Re),1===e.round?r(Re,Q).push(w.default(Re.container,Re.reload)):r(Re,ge).call(Re,n),Re.updateRoomStatus(h.RoomStatus.Preparing);break;case f.SocketMsgType.End:case f.SocketMsgType.Close:case f.SocketMsgType.Block:r(Re,ge).call(Re,n),Re.updateRoomStatus(h.RoomStatus.Preparing);break;case f.SocketMsgType.Refresh:t(e.cmd);break;case f.SocketMsgType.AreaBlock:break;case f.SocketMsgType.HotRoomNotify:if(!Array.isArray(e.data.random_delay_req_v2))break;a=performance.now()+1e3*Number(e.data.ttl),isNaN(a)?d.logger.error("HotRoomNotify ttl error: "+String(e.data.ttl)):(d.logger.debug("HotRoomNotify msg: "+JSON.stringify(e.data.random_delay_req_v2)),e.data.random_delay_req_v2.forEach(function(e){var t=e.path,n=e.delay;d.ajax.disperse(t,{scope:n,expiresTime:a})}));break;case f.SocketMsgType.LOG_IN_NOTICE:0===r(Re,i)&&r(Re,re).call(Re)}var a;Re.emit(d.ExternalEventType.ReceiveMessage,e)}}),o=e.on("heartbeat",function(e){Re.emit(d.ExternalEventType.ReceiveOnlineCount,e.count)});return function(){a(),o()}}),ve.set(this,function(e,t){var n;if(r(Re,P)instanceof v.LivePlayer){var i=null===(n=r(Re,P))||void 0===n?void 0:n.getVideoEl();"danmaku"===e&&r(Re,q).changeMaskState(i,t.enableMask),"playStatus"===e&&!0!==t&&(clearTimeout(r(Re,ee)),r(Re,q).changeMaskState(i,!1,!0))}}),fe.set(this,function(e,t){return a(Re,void 0,Promise,function(){var n,i,a,l,u,c,v=this;return o(this,function(o){switch(o.label){case 0:switch(e){case"report":return[3,1];case"shield":return[3,3];case"addBlackList":return[3,4]}return[3,5];case 1:return[4,r(this,ne).show({uid:t.uid,roomid:r(this,s),uname:t.uname,msg:t.text,checkInfo:t.checkInfo,type:t.dmType,file_id:null!==(l=null!==(i=null===(n=t.voiceConfig)||void 0===n?void 0:n.file_id)&&void 0!==i?i:null===(a=t.emoticonOptions)||void 0===a?void 0:a.emoticon_unique)&&void 0!==l?l:"",img_url:null!==(c=null===(u=t.emoticonOptions)||void 0===u?void 0:u.url)&&void 0!==c?c:"",id_str:t.id_str})];case 2:return o.sent(),[3,5];case 3:return p.roomBlockAdapter({component:"block",action:"addShieldUser",data:{uid:t.uid,uname:t.uname}},r(this,q),r(this,s),function(e,t){v.emit(d.ExternalEventType.Set,{component:"block",action:e,data:t})}),[3,5];case 4:return this.emit(d.ExternalEventType.Set,{component:"block",action:"addBlackList",data:t.uname}),[3,5];case 5:return[2]}})})}),pe.set(this,function(){r(Re,Q).forEach(function(e){return e()}),l(Re,Q,[])}),me.set(this,function(){var t=e(e({NAME:"BILIBILI HTML5 LIVE PLAYER",VERSION:m.ENV.VERSION},"development"===m.ENV.NODE_ENV?{socket:r(Re,D)}:{}),{play:function(){var e;null===(e=r(Re,P))||void 0===e||e.play()},pause:function(){var e;null===(e=r(Re,P))||void 0===e||e.pause()},volume:function(t){var n;d.userSetting.setVolume(e(e({},d.userSetting.getVolume()),{value:t})),null===(n=r(Re,P))||void 0===n||n.volume(t/100)},setDanmaku:function(){},reload:Re.reload,destroy:Re.destroy,getOperableElements:Re.getOperableElements,freeze:function(){var e;null===(e=r(Re,P))||void 0===e||e.blockStream()},refresh:function(){Re.reload().catch(function(e){d.logger.error(e)})},set:function(e){"block"===e.component&&p.roomBlockAdapter(e,r(Re,q),r(Re,s),function(e,t){Re.emit(d.ExternalEventType.Set,{component:"block",action:e,data:t})})},setFullscreenDanmaku:function(e){null!=r(Re,P)&&W(e,r(Re,P))},sendDanmaku:function(e){return a(Re,void 0,void 0,function(){var t=this;return o(this,function(n){switch(n.label){case 0:return[4,r(this,q).userSendDanmaku(e).then(function(n){var i={uniqueID:e.uniqueID,response:n};return t.emit(d.ExternalEventType.SendDanmaku,i),i})];case 1:return[2,n.sent()]}})})},setFullscreenStatus:function(e){null!=r(Re,P)&&r(Re,P).ctrl.setScreenStatus(e)},toast:function(e){d.toast(e,Re.container)},setToastCssText:function(e){d.setToastCssText(e)},notifyInOperation:function(e){Re.getOperableElements().mainElement.style.zIndex=""+(e?9:-1)},notifyAnnouncement:Re.notifyAnnouncement,injectInitAPIData:Re.injectInitAPIData,getVideoEl:function(){var e,t;return null!==(t=null===(e=r(Re,P))||void 0===e?void 0:e.getVideoEl())&&void 0!==t?t:null},supportMaskDanmaku:function(){return r(Re,q).supportMaskDanmaku()},featSupport:function(e){return"MaskDanmaku"===e?r(Re,q).supportMaskDanmaku():"VideoEnhance"===e?!d.ua.isSafari()&&null!=document.createElement("canvas").getContext("webgl2"):void 0},switchAudioTrack:function(e){var t,n;return r(Re,P)instanceof v.LivePlayer&&null!==(n=null===(t=r(Re,P))||void 0===t?void 0:t.switchAudioTrack(e))&&void 0!==n?n:-1},getAudioTracks:function(){var e;if(r(Re,P)instanceof v.LivePlayer)return null===(e=r(Re,P))||void 0===e?void 0:e.getAudioTracks()},changeUIStatus:function(t){var n,i,a,o,u,s=null===(n=r(Re,P))||void 0===n?void 0:n.getVideoEl();if(null!==(a=null===(i=JSON.stringify(Re.opts.roomInitDataV2))||void 0===i?void 0:i.includes("全景"))&&void 0!==a&&a&&null!=t.showMirror&&(t.showMirror=!1),null!=s&&(!0===t.enableMaskDanmaku?(r(Re,q).bodyMaskDetectorStatus=!0,r(Re,q).danmakuStateHandler.maskSwitch(!0)):!1===t.enableMaskDanmaku&&(r(Re,q).bodyMaskDetectorStatus=!1,r(Re,q).danmakuStateHandler.maskSwitch(!1))),!1===t.feedback?null===(o=r(Re,J))||void 0===o||o.call(Re):!0===t.feedback&&null==r(Re,J)&&l(Re,J,k.default(Re.container,r(Re,ue))),!1===t.logo?null===(u=r(Re,K))||void 0===u||u.destroy():!0===t.logo&&null==r(Re,K)&&l(Re,K,E.default(Re.container)),!1===t.recommend&&r(Re,oe).call(Re),Re.opts.UI=Object.assign({},Re.opts.UI,t),null!=r(Re,P)){var c=r(Re,P).ctrl.getCtrlUI();if(null!=t.showMirror&&(c.ctrlItemVisibility.mirror=t.showMirror),!1===t.webFullScreen&&(c.ctrlItemVisibility.webFullScreen=!1),null!=t.pip&&(c.ctrlItemVisibility.pip=t.pip),null!=t.pipStatus)if(c.pipStatus=t.pipStatus,t.pipStatus){var v=r(Re,P).getVideoEl();null==v||v.requestPictureInPicture().catch(d.logger.error)}else z();null!=t.showDanmakuSetting&&(c.ctrlItemVisibility=e(e({},c.ctrlItemVisibility),{danmakuPanel:t.showDanmakuSetting})),!1===t.danmaku&&m.disableDanmaku({danmakuBiz:r(Re,q),ctrl:r(Re,P).ctrl})}},changeDanmakuExtraConfig:function(e){r(Re,q).updateDanmakuExtraConfig(e)},changeCtrlVisible:function(e,t){var n,i=null===(n=r(Re,P))||void 0===n?void 0:n.ctrl;null!=i&&(i.setAutoHide(null==t||t),e?i.show():i.hide())},capturePic:function(e,t){var n,i;return null!==(i=null===(n=r(Re,P))||void 0===n?void 0:n.capturePic(e,t))&&void 0!==i?i:null},on:function(t,i){var a;if(t===d.ExternalEventType.Initialized)return i({type:"html5"}),void d.logger.info("room player emit external event: Initialized");if(t===d.ExternalEventType.InitDanmaku){var o=r(Re,q).getDanmakuConfig();return d.logger.info("room player emit external event: InitDanmaku, data: "+JSON.stringify(o)),void i(e(e({},o),{room_shield:null===(a=r(Re,n))||void 0===a?void 0:a.room_shield}))}return Re.on(t,i)},once:function(e,t){return Re.once(e,t)},addLoadingPicture:function(e){var t;null===(t=r(Re,P))||void 0===t||t.setTitlePageImg(e)},stopPlayback:function(e){var t;null!=r(Re,P)&&(r(Re,P).destroy(),r(Re,pe).call(Re),d.coverImg(null!==(t=null==e?void 0:e.url)&&void 0!==t?t:"//s1.hdslb.com/bfs/static/player/live/html5/images/error@1x.png",Re.container),r(Re,Q).push(function(){d.coverImg(null,Re.container)}))},getPlayerInfo:function(){var t,n,i=r(Re,P),a={type:1,version:m.ENV.VERSION,playerType:"HTML5",liveStatus:h.RoomStatus.Preparing,playerStatus:0,playingStatus:!1,playurl:"",guid:"",quality:"0",qualityCandidates:[]};if(null==i)return a;var o=i.getPlayerInfo(),l=null!==(t=i.ctrl.getCtrlUI().webFullScreenStatus)&&void 0!==t&&t?1:null!==(n=i.ctrl.getCtrlUI().fullScreenStatus)&&void 0!==n&&n?2:0;return e(e({},a),{liveStatus:i instanceof v.LivePlayer?1:0,playerStatus:l,playingStatus:o.playingStatus,playurl:o.playSrc,guid:o.guid,quality:o.quality,qualityCandidates:o.qualityCandidates.map(function(e){var t=e.label;return{qn:e.value,desc:t}}),volume:i.ctrl.getCtrlUI().volume,danmaku:d.userSetting.getDanmaku()})},switchQuality:function(e){r(Re,P)instanceof v.LivePlayer&&r(Re,P).switchQuality(e)},updateDMSetting:function(t){null!=r(Re,q)&&(d.userSetting.setDanmaku(e(e({},d.userSetting.getDanmaku()),t)),m.updateDanmakuSetting(t,r(Re,q)))},init:function(e,t){if("config"===e&&(null==t?void 0:t.isAdmin))r(Re,H).setAdmin();else if("autoSync"===e){var n=t;for(var i in t)n[i]=Number(t[i]);r(Re,Z).setAutoSyncCfg=n,r(Re,P)instanceof v.LivePlayer&&r(Re,P).setAutoSyncCfg(n)}else"VideoEnhance"===e&&(t?r(Re,ce).start(r(Re,P)):r(Re,ce).stop())},remainBufferLength:function(){return r(Re,P)instanceof v.LivePlayer?r(Re,P).remainBufferLength():0},discardFrame:function(e){if(r(Re,P)instanceof v.LivePlayer){if(!r(Re,P).getPlayerInfo().playingStatus)return;r(Re,P).discardFrame(e)}},sendGift:function(){},resize:function(){var e;r(Re,q).resize(),null===(e=r(Re,P))||void 0===e||e.ctrl.setMiniMode(Re.container.clientWidth<=500)},noticeGift:function(){},setChasingFrameThreshold:function(){},loadVideo:function(){},getP2PTransport:function(){if(r(Re,P)instanceof v.LivePlayer){var e=r(Re,P).getP2PTransport();return{downloadExtraFile:e.downloadExtraFile,shareExtraFile:e.shareExtraFile}}},changeCtrlIconVisible:r(Re,he),appendCtrlItem:function(e,t){var n;if(!(e instanceof Element))throw new Error("Illegal arguments, el not an Element");var i=null===(n=r(Re,P))||void 0===n?void 0:n.ctrl.getCtrlUI();if(null==i)throw Error("Can't get controller instance");return i.appendCtrlItem(e,t)},userFeedback:d.debounce(function(t){return a(Re,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return y.default.custom(y.default.CustomCode.UserFeedBack,t),[4,A(e(e({},t),{mid:r(this,i),buvid:r(this,ie)}))];case 1:return n.sent(),[2]}})})},400),setBottomBar:function(e,t,n){void 0===t&&(t="normal");var i=t,l=[],u=document.createElement("div");u.id="web-player__bottom-bar__container",u.style.cssText="\n          width: 100%;\n          position: absolute;\n          bottom: 0;\n          z-index: "+(null!=n?n.toString():"auto")+"\n        ",u.appendChild(e),Re.container.appendChild(u);var s=r(Re,q).getDanmakuElement(),c=function(e){var t;null!=r(Re,P)?null===(t=r(Re,P))||void 0===t||t.ctrl.setBottomDistance(e):l.push(Re.on(d.ExternalEventType.WebPlayerCreated,function(){var t;null===(t=r(Re,P))||void 0===t||t.ctrl.setBottomDistance(e)}))},v=function(){return a(Re,void 0,Promise,function(){var e=this;return o(this,function(t){switch(t.label){case 0:return[4,new Promise(function(t){var n;null==r(e,P)?l.push(e.on(d.ExternalEventType.FirstFrame,function(){var n;t(null===(n=r(e,P))||void 0===n?void 0:n.getVideoEl())})):t(null===(n=r(e,P))||void 0===n?void 0:n.getVideoEl())})];case 1:return[2,t.sent()]}})})},f=function(){v().then(function(e){null!=e&&(e.style.height="normal"===i?"calc(100% - "+u.clientHeight+"px)":"100%")}).catch(function(e){console.log(e)})},p=function(e,t){i=e,f(),s.style.height="normal"===e?"calc(100% - "+u.clientHeight+"px)":"100%",r(Re,q).resize(),u.style.zIndex=null!=t?t.toString():"auto"};p(t,n),c(u.clientHeight);var m=null!=window.ResizeObserver?new ResizeObserver(function(e){return c(e[0].target.clientHeight)}):null;null==m||m.observe(u),l.push(Re.on(d.ExternalEventType.FirstFrame,function(){null!=r(Re,P)&&f()}));return{remove:function(){Re.container.removeChild(u),v().then(function(e){null!=e&&(e.style.height="100%")}).catch(function(e){return console.log(e)}),s.style.height="100%",r(Re,q).resize(),c(0),null==m||m.unobserve(u),l.forEach(function(e){return e()}),l=[]},switchShowType:p}}}),u=function(e){var n=e;if("function"==typeof t[n]){if(["getPlayerInfo","notifyAnnouncement","notifyInOperation","on","set","getOperableElements","remainBufferLength","receiveOnlineCount"].includes(n))return"continue";var i=t[n];t[n]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return d.logger.debug("external call player api: "+n+", args: "+JSON.stringify(e)),i.apply(void 0,e)}}};for(var c in t)u(c);return t}),he.set(this,function(t){var n,i;if(null!=r(Re,P)){var a=r(Re,P).ctrl.getCtrlUI();a.ctrlItemVisibility=e(e({},a.ctrlItemVisibility),{playStatus:t.play,volume:t.volume,time:t.time,refresh:t.reload,quality:t.quality,rightSetting:t.setting,danmaku:t.danmaku,fullScreen:t.fullscreen,webFullScreen:t.webFullscreen}),t.danmaku?r(Re,q).fetchBlockRules():r(Re,q).destroy(),t.feedback||null===(n=r(Re,J))||void 0===n||n.call(Re),t.logo||null===(i=r(Re,K))||void 0===i||i.destroy()}}),ye.set(this,function(e){var t,n;if(r(Re,P)instanceof v.LivePlayer){var i=r(Re,P).ctrl.getCtrlUI().danmaku,a=null===(t=r(Re,P))||void 0===t?void 0:t.getVideoEl();if(null!=i&&null!=a){var o=null===(n=r(Re,P))||void 0===n?void 0:n.ctrl.getCtrlUI().playStatus;d.ua.isChrome()?(r(Re,q).onSei(e),i.enableMask&&(clearTimeout(r(Re,ee)),l(Re,ee,window.setTimeout(function(){o||(i.showMaskOption=!1,r(Re,q).changeMaskState(a,!1))},1e4))),i.showMaskOption=!0,!r(Re,q).maskState&&o&&r(Re,q).changeMaskState(a,i.enableMask)):(i.showMaskOption=!1,i.enableMask=!1,r(Re,q).changeMaskState(a,!1))}}}),this.notifyAnnouncement=(Ve=!1,function(e,t){void 0===e&&(e=!0),void 0===t&&(t=100),Ve!==e&&(Ve=e,r(Re,q).set({offsetTop:Ve?t:0}))}),this.updateRoomStatus=(De=h.RoomStatus.Preparing,function(e){var t;r(Re,q).danmakuStateHandler.maskSwitch(!1),null===(t=r(Re,P))||void 0===t||t.destroy(),l(Re,P,null),De!==e&&(De=e,Re.emit(d.ExternalEventType.LiveStateChange,De))}),this.injectInitAPIData=function(e){r(Re,q).initDanmakuConfig(e)},this.on=function(e,t){return r(Re,X).on(e,t)},this.once=function(e,t){return r(Re,X).once(e,t)},this.emit=function(e){for(var t,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];[d.ExternalEventType.ReceiveMessage,d.ExternalEventType.ReceiveOnlineCount,d.ExternalEventType.SEIParseData,d.ExternalEventType.SEIData].includes(e)||d.logger.info("room player emit external event: "+e+", data: "+JSON.stringify(n));try{(t=r(Re,X)).emit.apply(t,u([e],n))}catch(a){d.logger.error("ExternalEventHandler error, event type: "+e)}},ge.set(this,function(e,t){var n,i,a;void 0===t&&(t=""),null===(n=r(Re,ae))||void 0===n||n.remove(),l(Re,ae,document.createElement("div")),Re.container.appendChild(r(Re,ae)),l(Re,oe,g.endRecommendPanel(Re.container,r(Re,ae),{roomId:e,rnd:Re.opts.rnd,showRecommend:null===(a=null===(i=Re.opts.UI)||void 0===i?void 0:i.recommend)||void 0===a||a},function(e,t){"info"===e&&Re.emit(d.ExternalEventType.Recommend,t),"redirect"===e&&Re.emit(d.ExternalEventType.UserRedirect,t.data)},t))}),this.destroy=function(){var e,t,n,i;r(Re,Y)||(l(Re,Y,!0),null===(e=r(Re,ae))||void 0===e||e.remove(),l(Re,ae,null),r(Re,Ee).call(Re).el.remove(),r(Re,$).forEach(function(e){return e()}),l(Re,$,[]),d.logger.info("room player destroyed"),null===(t=r(Re,P))||void 0===t||t.destroy(),r(Re,D).destroy(),r(Re,q).destroy(),r(Re,j).destroy(),r(Re,G).destroy(),r(Re,H).destroy(),r(Re,pe).call(Re),r(Re,X).destroy(),null===(n=r(Re,J))||void 0===n||n.call(Re),null===(i=r(Re,K))||void 0===i||i.destroy())},this.getOperableElements=function(){return{mainElement:r(Re,Ee).call(Re).el}},Ee.set(this,function(){var e="web-player-inject-wrap",t=Re.container.querySelector("."+e);return null==t&&((t=document.createElement("div")).classList.add(e),t.style.cssText="\n        position: absolute;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        z-index: -1;\n      ",Re.container.appendChild(t),Re.on(d.ExternalEventType.LiveStateChange,function(e){null!=t&&(t.style.height=e===h.RoomStatus.Round||e===h.RoomStatus.Live?"auto":"100px")}),t.style.height=null==r(Re,P)?"100px":"auto"),{el:t}}),ke.set(this,function(){var e,t=r(Re,P);if(null!=t){var n=0,i="",a=d.seiKeyComparator(d.SEIType.BILIMASK__SVGBIN);r(Re,Q).push(B(t,Re.container,null===(e=Re.opts.UI)||void 0===e?void 0:e.enableAutoPlayTips),t.on(v.VideoEventType.Destroyed,function(){if(r(Re,q).danmakuStateHandler.maskSwitch(!1),t instanceof v.LivePlayer){var e=t.getVideoEl();r(Re,q).changeMaskState(e,!1),r(Re,q).clearMask()}}),t.ctrl.onChange(function(e,t){"volume"===e&&Re.emit(d.ExternalEventType.VolumeChange,t),r(Re,ve).call(Re,e,t),"show"===e&&Re.emit(d.ExternalEventType.CtrlVisibleChange,t)}),t.on(v.VideoEventType.SEIData,function(e){a(e[2])&&r(Re,ye).call(Re,e)}),t.on(v.VideoEventType.VideoInfo,function(e){r(Re,j).updateVideoTemplate(e),n=e.mediaInfo.videoDataRate;var t=e.mediaInfo,a=t.height>t.width?"vertical":"horizontal";a!==i&&(Re.emit(d.ExternalEventType.VideoDirectionChange,a),i=a)}),t.on(v.VideoEventType.LoadStart,d.runOnlyOnce("VideoEventType.LoadStart",function(){Re.emit(d.ExternalEventType.FirstLoadStart)})),t.on(v.VideoEventType.MetaData,d.runOnlyOnce("VideoEventType.MetaData",function(){Re.emit(d.ExternalEventType.FirstLoadedMetaData)})),t.on(v.VideoEventType.Play,d.runOnlyOnce("VideoEventType.Play",function(){Re.emit(d.ExternalEventType.FirstPlaying)})),t.on(v.VideoEventType.WaitStart,function(){var e,t,i=navigator.connection;d.logger.warn("connect downlink is: "+(null!==(e=null==i?void 0:i.downlink)&&void 0!==e?e:-1)+"Mbps,connect rtt is: "+(null!==(t=null==i?void 0:i.rtt)&&void 0!==t?t:-1)+"ms,video bitRate is: "+(n/1024).toFixed(2)+"Mbps")}))}}),Se.set(this,function(){C.default.exitFullscreen().catch(function(){d.logger.error("exit fullscreen error")}),Re.emit(d.ExternalEventType.WebFullscreen,!1,c.Other),Re.emit(d.ExternalEventType.ScreenStateChange,"normal")}),we.set(this,function(e){Re.emit(d.ExternalEventType.UserRedirect,e)});var Fe=this.opts,Le=Fe.cid,_e=Fe.roomInitDataV2,We=Fe.rnd,Oe=!0===be.isActivity?m.PlayerEnv.Activity:m.PlayerEnv.Room,Ue=m.initPlayer(Le,Oe),Ae=Ue.userId,Be=Ue.uvid;return r(this,$).push(d.ajax.watch(m.ajaxWatcher)),l(this,i,Ae),l(this,ie,Be),y.default.event(y.default.EventCode.RoomPlayerInit,null,{sampleRate:.5}),y.default.custom(y.default.CustomCode.SupportHEVC,{hard:d.isHardSupportHEVC(),soft:v.isBwpSupported()},{sampleRate:.1}),null!=_e&&_e.code>=0&&l(this,n,_e.data),l(this,s,Le),l(this,D,new f.default({roomId:Le,userId:Ae})),l(this,q,new p.DanmakuBiz(this.container,{userId:Ae,rnd:We,roomId:Le})),r(this,q).connectSocket(r(this,D),function(e){Re.emit(d.ExternalEventType.ReceiveMessage,e)}),!1===(null===(Te=be.UI)||void 0===Te?void 0:Te.danmaku)&&m.disableDanmaku({danmakuBiz:r(this,q)}),x.logStorageConfig({roomId:Le,socket:r(this,D)}),l(this,j,new T.default(this.container)),l(this,G,new M.default(this.container)),l(this,ne,new I.default(t)),l(this,H,new b.default(this.container,{uid:Ae,version:m.ENV.VERSION,click:e({handleEvent:r(this,we),handleDanmu:r(this,fe)},m.createContextmenuHandler(r(this,G),r(this,j)))})),l(this,re,L(r(this,q),r(this,H))),r(this,$).push(r(this,re),m.pressToOpenVideoInfoListener(this.container)),!1!==(null===(Ie=be.UI)||void 0===Ie?void 0:Ie.feedback)&&l(this,J,k.default(t,r(this,ue))),!1!==(null===(Me=be.UI)||void 0===Me?void 0:Me.logo)&&l(this,K,E.default(this.container)),this.reload().catch(function(e){d.logger.error(e)}),r(this,$).push(O(),U()),r(this,me).call(this)}var n,i,s,P,D,q,H,j,G,Q,J,K,Y,X,Z,$,ee,te,ne,ie,ae,oe,re,le,ue,se,ce,de,ve,fe,pe,me,he,ye,ge,Ee,ke,Se,we;return n=new WeakMap,i=new WeakMap,s=new WeakMap,P=new WeakMap,D=new WeakMap,q=new WeakMap,H=new WeakMap,j=new WeakMap,G=new WeakMap,Q=new WeakMap,J=new WeakMap,K=new WeakMap,Y=new WeakMap,X=new WeakMap,Z=new WeakMap,$=new WeakMap,ee=new WeakMap,te=new WeakMap,ne=new WeakMap,ie=new WeakMap,ae=new WeakMap,oe=new WeakMap,re=new WeakMap,le=new WeakMap,ue=new WeakMap,se=new WeakMap,ce=new WeakMap,de=new WeakMap,ve=new WeakMap,fe=new WeakMap,pe=new WeakMap,me=new WeakMap,he=new WeakMap,ye=new WeakMap,ge=new WeakMap,Ee=new WeakMap,ke=new WeakMap,Se=new WeakMap,we=new WeakMap,t.isSupported=m.isSupported,t.featSupport=function(e){return"MaskDanmaku"===e?p.DanmakuBiz.supportMaskDanmaku():"VideoEnhance"===e&&(!d.ua.isSafari()&&null!=document.createElement("canvas").getContext("webgl2"))},t}();function R(t,n,i){var a=n.getCtrlUI();a.danmaku=d.userSetting.getDanmaku(),a.danmaku.showMaskOption=!1;var o=0,r=n.onChange(function(n,i){if("webFullScreenStatus"===n)return clearTimeout(o),void(o=window.setTimeout(function(){t.resize()},10));"danmaku"===n&&(d.userSetting.setDanmaku(e(e({},a.danmaku),i)),m.updateDanmakuSetting(i,t)),"volume"===n&&d.userSetting.setVolume(e(e({},a.volume),i))}),l=C.default.onChange(function(){clearTimeout(o),o=window.setTimeout(function(){t.resize()},300)});return function(){r(),l(),clearTimeout(o)}}function F(e,t){var n,i,a=t.ctrl.getCtrlUI().line,o=a.list;"number"==typeof a.value&&e.setLines(o,a.value,t.switchLine.bind(t));var r=null===(n=t.replay)||void 0===n?void 0:n.on("timeShiftChange",function(n){"number"==typeof a.value&&n>0&&e.setLines([],a.value,t.switchLine.bind(t))}),l=null===(i=t.replay)||void 0===i?void 0:i.on("backLive",function(){"number"==typeof a.value&&e.setLines(o,a.value,t.switchLine.bind(t))}),u=t.on(d.ExternalEventType.SwitchLine,function(t){e.changeLine(t)});return function(){null==r||r(),null==l||l(),u()}}function L(e,t){return e.onSelect(function(e){return t.updateDanmuInfo(e)}),function(){e.offSelect()}}function _(e,t){var n=this,i=!1,r=e.onChange(function(r,l){return a(n,void 0,void 0,function(){var n;return o(this,function(a){switch(a.label){case 0:return n=e.getCtrlUI(),"fullScreenStatus"!==r?[3,6]:(!1===l&&(i=!0),!0===n.webFullScreenStatus&&y.default.operation(y.default.OperationCode.WebFullScreenWay,0),n.webFullScreenStatus=!1,t.emit(d.ExternalEventType.WebFullscreen,!1,c.Other),n.fullScreenStatus=l,!0!==l?[3,3]:t.container.contains(C.default.getFullscreenElement())?[3,2]:[4,C.default.requestFullscreen(t.container)]);case 1:a.sent(),a.label=2;case 2:return[3,5];case 3:return[4,C.default.exitFullscreen()];case 4:a.sent(),a.label=5;case 5:return t.emit(d.ExternalEventType.ScreenStateChange,l?"full":"normal"),[3,8];case 6:return"webFullScreenStatus"!==r?[3,8]:[4,C.default.exitFullscreen()];case 7:a.sent(),i=!0,n.fullScreenStatus=!1,t.emit(d.ExternalEventType.WebFullscreen,l,c.Click),t.emit(d.ExternalEventType.ScreenStateChange,l?"webFull":"normal"),!1===l&&e.hide(),a.label=8;case 8:return[2]}})})}),l=C.default.onChange(function(){var n=t.container===C.default.getFullscreenElement();n||i||(e.getCtrlUI().fullScreenStatus=!1,t.emit(d.ExternalEventType.ScreenStateChange,"normal")),t.emit(d.ExternalEventType.FullscreenChange,n,i?c.Click:c.Esc),i=!1});return function(){l(),r()}}function W(e,t){e.on("danmuInputBlur",function(){t.ctrl.setAutoHide(!0)}),e.on("danmuInputFocus",function(){t.ctrl.setAutoHide(!1)})}function O(){var e=function e(){return window.setTimeout(function(){y.default.custom(y.default.CustomCode.HangUp,{time:Math.floor(performance.now()/1e3),visible:"visible"===document.visibilityState?1:0}),clearTimeout(t),t=e()},18e5)},t=e(),n=function(){clearTimeout(t),t=e()};return window.addEventListener("mousemove",n),function(){window.removeEventListener("mousemove",n),clearTimeout(t)}}function U(){var e=setInterval(function(){var e,t,n=navigator.connection;y.default.custom(y.default.CustomCode.NetSpeed,{downlink:null!==(e=null==n?void 0:n.downlink)&&void 0!==e?e:-1,rtt:null!==(t=null==n?void 0:n.rtt)&&void 0!==t?t:-1},{sampleRate:.1})},18e4);return function(){clearInterval(e)}}function A(e){return a(this,void 0,Promise,function(){var t,n;return o(this,function(i){switch(i.label){case 0:if(!["其他问题或建议","黑屏","播放卡顿"].includes(e.type))return[2];t=5,n=36e5,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,x.goldMiner.report({startTime:Date.now()-n,endTime:Date.now(),latestCount:t,source:"player-report["+e.type+"]"})];case 2:return i.sent(),[3,4];case 3:return i.sent(),y.default.error(y.default.ErrorCode.ApiBiz,"LogReportFail"),[3,4];case 4:return[2]}})})}exports.RoomPlayer=D;var B=function(e,t,n){var i=null==n||n,a=[];return a.push(e.on(v.VideoEventType.MutePlay,function(){if(i){var n=P.createMutePlayTip(t,e.ctrl,function(){var t=e.getVideoEl();null!=t&&(t.muted=!1)});e.ctrl.getCtrlUI().show?n.change(!0):n.change(!1),a.push(e.on(v.VideoEventType.Destroyed,n.destroy),e.ctrl.onRefresh(n.destroy),e.on(d.ExternalEventType.SwitchLine,n.destroy),e.on(d.ExternalEventType.SwitchQuality,n.destroy),n.destroy,e.ctrl.onChange(function(e,t){if("show"===e&&(t?n.change(!0):n.change(!1)),"volume"===e){var i=t,a=i.disabled,o=i.value;(!a||o>0)&&n.destroy()}}))}})),a.push(e.on(v.VideoEventType.NotAutoPlay,function(){if(i){var n=P.createNotAutoPlayTip(t,function(){var t=e.getVideoEl();null!=t&&(t.muted=!1,t.play().catch(function(e){d.logger.error("click btn to play failed")}))});a.push(e.on(v.VideoEventType.Destroyed,function(){n()}))}})),function(){a.forEach(function(e){e()})}},q=!1;function N(t){if(!(q||(q=!0,Math.random()>.01))){var n=0,i=d.monitorFPS({type:"avg"},function(e){n=e});window.setTimeout(function(){var o;i(),y.default.perf(y.default.PerfCode.DevicePerf,n,{params:e(e({cpuCnt:navigator.hardwareConcurrency,mem:null!==(o=navigator.deviceMemory)&&void 0!==o?o:-1},a()),{dmSwitch:t.dmSwitch,maskDM:t.dmBiz.bodyMaskDetectorStatus}),extFields:[]})},1e4)}function a(){var e=document.createElement("canvas").getContext("experimental-webgl"),t={renderer:"",vendor:""};if(null==e)return t;var n=e.getExtension("WEBGL_debug_renderer_info");return null!=n&&(t.renderer=e.getParameter(n.UNMASKED_RENDERER_WEBGL),t.vendor=e.getParameter(n.UNMASKED_VENDOR_WEBGL)),t}}function z(){null!=document.pictureInPictureElement&&document.exitPictureInPicture().catch(function(e){d.logger.error(e)})}window.Player=D;
})()